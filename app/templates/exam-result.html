{% extends 'layout/base.html' %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Result Header Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="card-title mb-0 fs-1">
                        <i class="fas fa-trophy me-2"></i>
                        Kết Quả Bài Thi
                    </h2>
                </div>

                <div class="card-body p-4">
                    <!-- Exam Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4 class="text-primary mb-3 fs-3">
                                <i class="fas fa-file-alt me-2"></i>
                                {{ result.exam_name or result.exam.exam_name }}
                                {% if not result.exam %}
                                    <span class="badge bg-secondary ms-2">Đã xóa</span>
                                {% endif %}
                            </h4>
                            {% if result.exam %}
                                <p class="text-muted mb-2">
                                    <i class="fas fa-clock me-2"></i>
                                    <strong>Thời gian:</strong> {{ result.exam.duration }} phút
                                </p>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-book me-2"></i>
                                    <strong>Môn học:</strong> {{ result.exam.subject.subject_name }}
                                </p>
                            {% else %}
                                <p class="text-secondary mb-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Lưu ý:</strong> Đề thi này đã bị xóa. Bạn chỉ có thể xem điểm số.
                                </p>
                            {% endif %}
                            <p class="text-muted mb-2">
                                <i class="fas fa-calendar me-2"></i>
                                <strong>Ngày thi:</strong> {{ result.taken_exam.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                            <p class="text-success mb-2">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Thời gian đã làm:</strong>
                                {% if result.time_taken %}
                                    {% set minutes = (result.time_taken // 60) %}
                                    {% set seconds = (result.time_taken % 60) %}
                                    {% if minutes > 0 %}
                                        {{ minutes }} phút {% if seconds > 0 %}{{ seconds }} giây{% endif %}
                                    {% else %}
                                        {{ seconds }} giây
                                    {% endif %}
                                {% else %}
                                    --
                                {% endif %}
                            </p>
                        </div>

                        <div class="col-md-6 text-center">
                            <!-- Score Display -->
                            <div class="score-circle mx-auto mb-3">
                                {% if result.score >= 80 %}
                                <div class="circle-progress excellent">
                                    {% elif result.score >= 65 %}
                                    <div class="circle-progress good">
                                        {% elif result.score >= 50 %}
                                        <div class="circle-progress average">
                                            {% else %}
                                            <div class="circle-progress poor">
                                                {% endif %}
                                                <div class="circle-content">
                                                    <div class="score-number">{{ result.score }}</div>
                                                    <div class="score-label">điểm</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Score Status -->
                                        {% if result.score >= 80 %}
                                        <h5 class="text-success mb-2">
                                            <i class="fas fa-star me-1"></i>
                                            Xuất sắc
                                        </h5>
                                        <p class="text-muted">Chúc mừng! Bạn đã có kết quả rất tốt!</p>
                                        {% elif result.score >= 65 %}
                                        <h5 class="text-info mb-2">
                                            <i class="fas fa-thumbs-up me-1"></i>
                                            Khá tốt
                                        </h5>
                                        <p class="text-muted">Kết quả khá tốt, hãy tiếp tục cố gắng!</p>
                                        {% elif result.score >= 50 %}
                                        <h5 class="text-warning mb-2">
                                            <i class="fas fa-check me-1"></i>
                                            Đạt yêu cầu
                                        </h5>
                                        <p class="text-muted">Bạn đã đạt mức tối thiểu, hãy cải thiện thêm!</p>
                                        {% else %}
                                        <h5 class="text-danger mb-2">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Cần cố gắng
                                        </h5>
                                        <p class="text-muted">Bạn cần ôn tập và cố gắng hơn nữa!</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="stat-icon text-primary mb-3">
                                            <i class="fas fa-percentage fa-2x"></i>
                                        </div>
                                        <h3 class="card-title text-primary">{{ result.score }}%</h3>
                                        <p class="card-text text-muted">Điểm số đạt được</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="stat-icon text-info mb-3">
                                            <i class="fas fa-list-ol fa-2x"></i>
                                        </div>
                                        <h3 class="card-title text-info">
                                            {% set total_questions = result.exam.exam_questions|length %}
                                            {% set correct_answers = ((result.score / 100) * total_questions)|round|int
                                            %}
                                            {{ correct_answers }}/{{ total_questions }}
                                        </h3>
                                        <p class="card-text text-muted">Câu trả lời đúng</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="stat-icon text-success mb-3">
                                            <i class="fas fa-stopwatch fa-2x"></i>
                                        </div>
                                        <h3 class="card-title text-success">
                                            {{ result.exam.duration }} phút
                                        </h3>
                                        <p class="card-text text-muted">Thời gian cho phép</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Questions Review Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0 fs-4">
                                            <i class="fas fa-list-alt me-2"></i>
                                            Chi Tiết Các Câu Hỏi
                                        </h5>
                                        {% if result.exam and questions_with_answers %}
                                            <button class="btn btn-outline-primary btn-sm" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#questionsReview">
                                                <i class="fas fa-eye me-1"></i>
                                                Xem Chi Tiết
                                            </button>
                                        {% else %}
                                            <span class="text-muted">
                                                <i class="fas fa-ban me-1"></i>
                                                Không khả dụng
                                            </span>
                                        {% endif %}
                                    </div>
                                    {% if result.exam and questions_with_answers %}
                                        <div class="collapse" id="questionsReview">
                                            <div class="card-body">
                                                {% for question_data in questions_with_answers %}
                                                <div class="question-review mb-4 p-3 border rounded">
                                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                                        <h6 class="question-title mb-0">
                                                            <span class="badge bg-secondary me-2">Câu {{ loop.index }}</span>
                                                            {{ question_data.question.question_title }}
                                                        </h6>
                                                        {% if question_data.is_correct %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-check me-1"></i>Đúng
                                                        </span>
                                                        {% else %}
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-times me-1"></i>Sai
                                                        </span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="answers-list">
                                                        {% for answer in question_data.answers %}
                                                        <div class="form-check mb-2 p-2 rounded
                                                                {% if answer.is_correct %}bg-success bg-opacity-10 border border-success
                                                                {% elif answer.id == question_data.user_answer_id %}bg-danger bg-opacity-10 border border-danger
                                                                {% endif %}">
                                                            <input class="form-check-input" type="radio" disabled
                                                                   {% if answer.id == question_data.user_answer_id %}checked{% endif %}>
                                                            <label class="form-check-label">
                                                                {{ answer.answer_text }}
                                                                {% if answer.is_correct %}
                                                                <i class="fas fa-check-circle text-dark ms-2"></i>
                                                                {% elif answer.id == question_data.user_answer_id %}
                                                                <i class="fas fa-times-circle text-dark ms-2"></i>
                                                                {% endif %}
                                                            </label>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="card-body">
                                            <div class="alert alert-warning text-center">
                                                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                                                <h5>Không thể xem chi tiết câu hỏi</h5>
                                                <p class="mb-0">Đề thi này đã bị xóa bởi người tạo. Bạn chỉ có thể xem điểm số và thống kê cơ bản.</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body text-center py-4">
                                        <div class="d-flex flex-wrap justify-content-center gap-3">
                                            {% if result.exam %}
                                                <a href="{{ url_for('exam_detail', id=result.exam.id) }}" class="btn btn-outline-primary btn-lg hover-underline-center">
                                                    <i class="fas fa-eye me-2"></i>
                                                    Xem Chi Tiết Đề Thi
                                                </a>
                                                <button type="button" class="btn btn-primary btn-lg hover-underline-center" onclick="confirmRetakeExam()">
                                                    <i class="fas fa-redo me-2"></i>Làm Lại Bài Thi
                                                </button>
                                            {% else %}
                                                <button class="btn btn-outline-secondary btn-lg" disabled title="Đề thi đã bị xóa">
                                                    <i class="fas fa-ban me-2"></i>
                                                    Đề thi đã bị xóa
                                                </button>
                                            {% endif %}
                                            <a href="{{ url_for('subjects') }}" class="btn btn-outline-secondary btn-lg hover-underline-center">
                                                <i class="fas fa-book me-2"></i>
                                                Tìm Đề Thi Khác
                                            </a>
                                            <a href="{{ url_for('index') }}" class="btn btn-outline-success btn-lg hover-underline-center">
                                                <i class="fas fa-home me-2"></i>
                                                Về Trang Chủ
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Analysis -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="card-title mb-0 fs-4">
                                            <i class="fas fa-chart-line me-2"></i>
                                            Phân Tích Kết Quả
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-dark mb-3">Đánh giá chi tiết:</h6>
                                                <ul class="list-unstyled">
                                                    {% if result.score >= 80 %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        Bạn có hiểu biết rất tốt về môn học này.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        Kỹ năng giải bài tập xuất sắc.
                                                    </li>
                                                    {% elif result.score >= 65 %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-check-circle text-info me-2"></i>
                                                        Bạn có nền tảng kiến thức khá tốt.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                                        Cần ôn tập thêm một số phần để hoàn thiện.
                                                    </li>
                                                    {% elif result.score >= 50 %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-check-circle text-warning me-2"></i>
                                                        Bạn đã nắm được kiến thức cơ bản.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                                        Nên dành thời gian ôn tập thêm.
                                                    </li>
                                                    {% else %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-times-circle text-danger me-2"></i>
                                                        Cần học lại từ đầu các kiến thức cơ bản.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                                        Nên tìm hiểu thêm tài liệu học tập.
                                                    </li>
                                                    {% endif %}
                                                </ul>
                                            </div>

                                            <div class="col-md-6">
                                                <h6 class="text-dark mb-3">Gợi ý cải thiện:</h6>
                                                <ul class="list-unstyled">
                                                    {% if result.score < 80 %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                                        Ôn tập lại các câu trả lời sai.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                                        Làm thêm các đề thi tương tự.
                                                    </li>
                                                    {% endif %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-lightbulb text-info me-2"></i>
                                                        Tham khảo tài liệu bổ sung.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-lightbulb text-info me-2"></i>
                                                        Thảo luận với bạn bè và giáo viên.
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Analysis Section -->
                        {% if result.exam %}
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="card-title mb-0 fs-4">
                                            <i class="fas fa-chart-line me-2"></i>
                                            Phân Tích Biểu Đồ
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <ul class="nav nav-pills mb-4" id="resultChartTabs" role="tablist">
                                            <li class="nav-item">
                                                <button class="nav-link active" id="performance-radar-tab" data-bs-toggle="tab" data-bs-target="#performance-radar" type="button">
                                                    <i class="fas fa-radar-chart me-1"></i>Tổng Quan Hiệu Suất
                                                </button>
                                            </li>
                                            <li class="nav-item">
                                                <button class="nav-link" id="score-comparison-tab" data-bs-toggle="tab" data-bs-target="#score-comparison" type="button">
                                                    <i class="fas fa-line-chart me-1"></i>So Sánh Điểm
                                                </button>
                                            </li>
                                            <li class="nav-item">
                                                <button class="nav-link" id="question-analysis-tab" data-bs-toggle="tab" data-bs-target="#question-analysis" type="button">
                                                    <i class="fas fa-pie-chart me-1"></i>Phân Tích Câu Hỏi
                                                </button>
                                            </li>
                                        </ul>

                                        <!-- Chart Content -->
                                        <div class="tab-content" id="resultChartTabsContent">
                                            <div class="tab-pane fade show active" id="performance-radar">
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <canvas id="performanceRadarChart"></canvas>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="mt-3">
                                                            <h6 class="text-muted">Giải thích chỉ số:</h6>
                                                            <div class="small">
                                                                <div class="mb-2">
                                                                    <i class="fas fa-circle text-primary me-1"></i>
                                                                    <strong>Điểm số:</strong> Kết quả bài thi
                                                                </div>
                                                                <div class="mb-2">
                                                                    <i class="fas fa-circle text-success me-1"></i>
                                                                    <strong>Thời gian:</strong> Hiệu quả sử dụng thời gian
                                                                </div>
                                                                <div class="mb-2">
                                                                    <i class="fas fa-circle text-info me-1"></i>
                                                                    <strong>Độ chính xác:</strong> Tỷ lệ câu trả lời đúng
                                                                </div>
                                                                <div class="mb-2">
                                                                    <i class="fas fa-circle text-warning me-1"></i>
                                                                    <strong>Hiệu quả:</strong> Tỷ lệ điểm/thời gian
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="score-comparison">
                                                <div class="row">
                                                    <div class="col-12">
                                                        <canvas id="scoreComparisonChart"></canvas>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="tab-pane fade" id="question-analysis">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <canvas id="questionAnalysisChart"></canvas>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <div class="mt-3">
                                                            <h6 class="text-muted">Phân tích chi tiết:</h6>
                                                            <div id="questionDetailsInfo">
                                                                <div class="text-center text-muted">
                                                                    <i class="fas fa-spinner fa-spin"></i> Đang phân tích...
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <!-- Thông báo khi không thể hiển thị biểu đồ do đề thi đã xóa -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body text-center py-5">
                                        <div class="mb-4">
                                            <i class="fas fa-chart-line fa-4x text-muted"></i>
                                        </div>
                                        <h5 class="text-muted mb-3">Không thể hiển thị biểu đồ phân tích</h5>
                                        <p class="text-muted">
                                            Do đề thi này đã bị xóa, chúng tôi không thể hiển thị các biểu đồ phân tích chi tiết.
                                            Bạn chỉ có thể xem điểm số và thông tin cơ bản.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận làm lại bài thi sau khi làm 1 lần -->
<div class="modal fade" id="retakeExamModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0"
                 style="background: linear-gradient(135deg, #384AD5 0%, #5a67d8 100%);">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-redo me-2"></i>Bắt đầu ôn thi lại
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-question-circle text-primary fs-1 mb-3"></i>
                    <h5 class="fw-bold">Bạn có muốn làm lại bài thi này không?</h5>
                    <p class="text-muted">Bạn sẽ tạo một phiên thi mới và có thể cải thiện điểm số của mình.</p>
                </div>

                <div class="notification-box notification-info">
                    <div class="notification-content-small">
                        <i class="bi bi-info-circle notification-icon-small"></i>
                        <div class="notification-text small-text">
                            Điểm số cao nhất của bạn sẽ được lưu lại để so sánh.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="retakeExam()" style="background: #384AD5;">
                    <i class="fas fa-play me-2"></i>Bắt đầu làm bài
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function getExamId() {
        if (typeof examId !== 'undefined') return examId;

        const urlParams = new URLSearchParams(window.location.search);
        const urlExamId = urlParams.get('id') || urlParams.get('exam_id');
        if (urlExamId) return urlExamId;

        const pathMatch = window.location.pathname.match(/doing-exam\/(\d+)/);
        if (pathMatch) return pathMatch[1];

        const examElement = document.querySelector('[data-exam-id]');
        if (examElement) return examElement.dataset.examId;

        return null;
    }

    function confirmRetakeExam() {
        const modal = new bootstrap.Modal(document.getElementById('retakeExamModal'));
        modal.show();
    }

    function retakeExam() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('retakeExamModal'));
        modal.hide();

        const examId = getExamId();
        if (!examId) {
            alert('Không thể xác định bài thi!');
            return;
        }
        showLoadingOverlay('Đang khởi tạo bài thi mới...', 'Vui lòng đợi trong giây lát');
        window.location.href = `/doing-exam/${examId}`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const resultId = {{ result.id }};
        const hasExam = {{ 'true' if result.exam else 'false' }};
        if (resultId && hasExam) {
            loadExamResultCharts(resultId);
        }
    });

    function loadExamResultCharts(resultId) {
        fetch(`/api/exam-result/charts/${resultId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(text => {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    console.error('Response is not JSON:', text);
                    throw new Error('Invalid JSON response');
                }
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                createPerformanceRadarChart(data.performance_radar);
                createScoreComparisonChart(data.score_comparison);
                createQuestionAnalysisChart(data.question_analysis);
                updateResultAnalysisInfo(data);
            })
            .catch(error => {
                console.error('Error loading result charts:', error);
                showResultChartError(error.message);
            });
    }

    function createPerformanceRadarChart(data) {
        const ctx = document.getElementById('performanceRadarChart');
        if (!ctx) return;

        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Hiệu suất của bạn',
                    data: data.data,
                    borderColor: '#384AD5',
                    backgroundColor: 'rgba(56, 74, 213, 0.2)',
                    pointBackgroundColor: '#384AD5'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Tổng Quan Hiệu Suất Bài Thi'
                    }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    function createScoreComparisonChart(data) {
        const ctx = document.getElementById('scoreComparisonChart');
        if (!ctx) return;

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Điểm số các lần thi',
                    data: data.data,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 6,
                    pointHoverRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'So Sánh Điểm Các Lần Thi'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    }

    function createQuestionAnalysisChart(data) {
        const ctx = document.getElementById('questionAnalysisChart');
        if (!ctx) return;

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.labels,
                datasets: [{
                    data: data.data,
                    backgroundColor: [
                        '#28a745', // Đúng - xanh lá
                        '#dc3545'  // Sai - đỏ
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Phân Tích Câu Trả Lời'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    function updateResultAnalysisInfo(data) {
        const questionContainer = document.getElementById('questionDetailsInfo');
        if (questionContainer && data.question_analysis) {
            const total = data.question_analysis.data.reduce((a, b) => a + b, 0);
            const correct = data.question_analysis.data[0] || 0;
            const accuracy = total > 0 ? (correct / total * 100).toFixed(1) : 0;

            questionContainer.innerHTML = `
                <div class="alert alert-${accuracy >= 80 ? 'success' : accuracy >= 65 ? 'info' : accuracy >= 50 ? 'warning' : 'danger'}">
                    <h6 class="mb-2">Độ chính xác: ${accuracy}%</h6>
                    <p class="mb-1">Số câu đúng: ${correct}/${total}</p>
                    <p class="mb-0">
                        ${accuracy >= 80 ? 'Excellent! Bạn đã trả lời rất chính xác.' :
                          accuracy >= 65 ? 'Good! Kết quả khá tốt.' :
                          accuracy >= 50 ? 'Average. Cần cải thiện thêm.' :
                          'Cần ôn tập kỹ hơn các kiến thức cơ bản.'}
                    </p>
                </div>
            `;
        }
    }

    function showResultChartError(errorMessage = 'Không thể tải dữ liệu biểu đồ') {
        const chartContainers = ['performanceRadarChart', 'scoreComparisonChart', 'questionAnalysisChart'];
        chartContainers.forEach(id => {
            const container = document.getElementById(id);
            if (container) {
                container.parentElement.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i class="fas fa-exclamation-triangle mb-2"></i><br>
                        ${errorMessage}
                    </div>
                `;
            }
        });
    }
</script>
{% endblock %}