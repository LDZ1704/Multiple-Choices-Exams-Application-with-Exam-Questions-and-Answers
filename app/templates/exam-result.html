{% extends 'layout/base.html' %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Result Header Card -->
            <div class="card shadow-lg border-0 mb-4">
                <div class="card-header bg-primary text-white text-center py-4">
                    <h2 class="card-title mb-0 fs-1">
                        <i class="fas fa-trophy me-2"></i>
                        Kết Quả Bài Thi
                    </h2>
                </div>

                <div class="card-body p-4">
                    <!-- Exam Info -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h4 class="text-primary mb-3 fs-3">
                                <i class="fas fa-file-alt me-2"></i>
                                {{ result.exam.exam_name }}
                            </h4>
                            <p class="text-muted mb-2">
                                <i class="fas fa-book me-2"></i>
                                <strong>Môn học:</strong> {{ result.exam.subject.subject_name }}
                            </p>
                            <p class="text-muted mb-2">
                                <i class="fas fa-clock me-2"></i>
                                <strong>Thời gian làm bài:</strong> {{ result.exam.duration }} phút
                            </p>
                            <p class="text-muted mb-0">
                                <i class="fas fa-calendar me-2"></i>
                                <strong>Ngày thi:</strong> {{ result.taken_exam.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                        </div>

                        <div class="col-md-6 text-center">
                            <!-- Score Display -->
                            <div class="score-circle mx-auto mb-3">
                                {% if result.score >= 80 %}
                                <div class="circle-progress excellent">
                                    {% elif result.score >= 65 %}
                                    <div class="circle-progress good">
                                        {% elif result.score >= 50 %}
                                        <div class="circle-progress average">
                                            {% else %}
                                            <div class="circle-progress poor">
                                                {% endif %}
                                                <div class="circle-content">
                                                    <div class="score-number">{{ result.score }}</div>
                                                    <div class="score-label">điểm</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Score Status -->
                                        {% if result.score >= 80 %}
                                        <h5 class="text-success mb-2">
                                            <i class="fas fa-star me-1"></i>
                                            Xuất sắc
                                        </h5>
                                        <p class="text-muted">Chúc mừng! Bạn đã có kết quả rất tốt!</p>
                                        {% elif result.score >= 65 %}
                                        <h5 class="text-info mb-2">
                                            <i class="fas fa-thumbs-up me-1"></i>
                                            Khá tốt
                                        </h5>
                                        <p class="text-muted">Kết quả khá tốt, hãy tiếp tục cố gắng!</p>
                                        {% elif result.score >= 50 %}
                                        <h5 class="text-warning mb-2">
                                            <i class="fas fa-check me-1"></i>
                                            Đạt yêu cầu
                                        </h5>
                                        <p class="text-muted">Bạn đã đạt mức tối thiểu, hãy cải thiện thêm!</p>
                                        {% else %}
                                        <h5 class="text-danger mb-2">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            Cần cố gắng
                                        </h5>
                                        <p class="text-muted">Bạn cần ôn tập và cố gắng hơn nữa!</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Statistics -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="stat-icon text-primary mb-3">
                                            <i class="fas fa-percentage fa-2x"></i>
                                        </div>
                                        <h3 class="card-title text-primary">{{ result.score }}%</h3>
                                        <p class="card-text text-muted">Điểm số đạt được</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="stat-icon text-info mb-3">
                                            <i class="fas fa-list-ol fa-2x"></i>
                                        </div>
                                        <h3 class="card-title text-info">
                                            {% set total_questions = result.exam.exam_questions|length %}
                                            {% set correct_answers = ((result.score / 100) * total_questions)|round|int
                                            %}
                                            {{ correct_answers }}/{{ total_questions }}
                                        </h3>
                                        <p class="card-text text-muted">Câu trả lời đúng</p>
                                    </div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm h-100">
                                    <div class="card-body text-center">
                                        <div class="stat-icon text-success mb-3">
                                            <i class="fas fa-stopwatch fa-2x"></i>
                                        </div>
                                        <h3 class="card-title text-success">
                                            {{ result.exam.duration }} phút
                                        </h3>
                                        <p class="card-text text-muted">Thời gian cho phép</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Questions Review Section -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0 fs-4">
                                            <i class="fas fa-list-alt me-2"></i>
                                            Chi Tiết Các Câu Hỏi
                                        </h5>
                                        <button class="btn btn-outline-primary btn-sm" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#questionsReview">
                                            <i class="fas fa-eye me-1"></i>
                                            Xem Chi Tiết
                                        </button>
                                    </div>
                                    <div class="collapse" id="questionsReview">
                                        <div class="card-body">
                                            {% if questions_with_answers %}
                                            {% for question_data in questions_with_answers %}
                                            <div class="question-review mb-4 p-3 border rounded">
                                                <div class="d-flex justify-content-between align-items-start mb-3">
                                                    <h6 class="question-title mb-0">
                                                        <span class="badge bg-secondary me-2">Câu {{ loop.index }}</span>
                                                        {{ question_data.question.question_title }}
                                                    </h6>
                                                    {% if question_data.is_correct %}
                                                    <span class="badge bg-success">
                                                                <i class="fas fa-check me-1"></i>Đúng
                                                            </span>
                                                    {% else %}
                                                    <span class="badge bg-danger">
                                                                <i class="fas fa-times me-1"></i>Sai
                                                            </span>
                                                    {% endif %}
                                                </div>

                                                <div class="answers-list">
                                                    {% for answer in question_data.answers %}
                                                    <div class="form-check mb-2 p-2 rounded
                                                            {% if answer.is_correct %}bg-success bg-opacity-10 border border-success
                                                            {% elif answer.id == question_data.user_answer_id %}bg-danger bg-opacity-10 border border-danger
                                                            {% endif %}">
                                                        <input class="form-check-input" type="radio" disabled
                                                               {% if answer.id== question_data.user_answer_id
                                                               %}checked{% endif %}>
                                                        <label class="form-check-label">
                                                            {{ answer.answer_text }}
                                                            {% if answer.is_correct %}
                                                            <i class="fas fa-check-circle text-dark ms-2"></i>
                                                            {% elif answer.id == question_data.user_answer_id %}
                                                            <i class="fas fa-times-circle text-dark ms-2"></i>
                                                            {% endif %}
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                            {% else %}
                                            <p class="text-muted text-center">Không có dữ liệu chi tiết câu hỏi.</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body text-center py-4">
                                        <div class="d-flex flex-wrap justify-content-center gap-3">
                                            <a href="{{ url_for('exam_detail', id=result.exam.id) }}" class="btn btn-outline-primary btn-lg hover-underline-center">
                                                <i class="fas fa-eye me-2"></i>
                                                Xem Chi Tiết Đề Thi
                                            </a>
                                            <button type="button" class="btn btn-primary btn-lg hover-underline-center" onclick="confirmRetakeExam()">
                                                <i class="fas fa-redo me-2"></i>Làm Lại Bài Thi
                                            </button>
                                            <a href="{{ url_for('subjects') }}" class="btn btn-outline-secondary btn-lg hover-underline-center">
                                                <i class="fas fa-book me-2"></i>
                                                Tìm Đề Thi Khác
                                            </a>
                                            <a href="{{ url_for('index') }}" class="btn btn-outline-success btn-lg hover-underline-center">
                                                <i class="fas fa-home me-2"></i>
                                                Về Trang Chủ
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Analysis -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-light">
                                        <h5 class="card-title mb-0 fs-4">
                                            <i class="fas fa-chart-line me-2"></i>
                                            Phân Tích Kết Quả
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="text-dark mb-3">Đánh giá chi tiết:</h6>
                                                <ul class="list-unstyled">
                                                    {% if result.score >= 80 %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        Bạn có hiểu biết rất tốt về môn học này.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-check-circle text-success me-2"></i>
                                                        Kỹ năng giải bài tập xuất sắc.
                                                    </li>
                                                    {% elif result.score >= 65 %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-check-circle text-info me-2"></i>
                                                        Bạn có nền tảng kiến thức khá tốt.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                                        Cần ôn tập thêm một số phần để hoàn thiện.
                                                    </li>
                                                    {% elif result.score >= 50 %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-check-circle text-warning me-2"></i>
                                                        Bạn đã nắm được kiến thức cơ bản.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-exclamation-circle text-warning me-2"></i>
                                                        Nên dành thời gian ôn tập thêm.
                                                    </li>
                                                    {% else %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-times-circle text-danger me-2"></i>
                                                        Cần học lại từ đầu các kiến thức cơ bản.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-exclamation-circle text-danger me-2"></i>
                                                        Nên tìm hiểu thêm tài liệu học tập.
                                                    </li>
                                                    {% endif %}
                                                </ul>
                                            </div>

                                            <div class="col-md-6">
                                                <h6 class="text-dark mb-3">Gợi ý cải thiện:</h6>
                                                <ul class="list-unstyled">
                                                    {% if result.score < 80 %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                                        Ôn tập lại các câu trả lời sai.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                                        Làm thêm các đề thi tương tự.
                                                    </li>
                                                    {% endif %}
                                                    <li class="mb-2">
                                                        <i class="fas fa-lightbulb text-info me-2"></i>
                                                        Tham khảo tài liệu bổ sung.
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fas fa-lightbulb text-info me-2"></i>
                                                        Thảo luận với bạn bè và giáo viên.
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận làm lại bài thi sau khi làm 1 lần -->
<div class="modal fade" id="retakeExamModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0"
                 style="background: linear-gradient(135deg, #384AD5 0%, #5a67d8 100%);">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-redo me-2"></i>Bắt đầu ôn thi lại
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-question-circle text-primary fs-1 mb-3"></i>
                    <h5 class="fw-bold">Bạn có muốn làm lại bài thi này không?</h5>
                    <p class="text-muted">Bạn sẽ tạo một phiên thi mới và có thể cải thiện điểm số của mình.</p>
                </div>

                <div class="notification-box notification-info">
                    <div class="notification-content">
                        <i class="bi bi-info-circle notification-icon"></i>
                        <div class="notification-text small-text">
                            Điểm số cao nhất của bạn sẽ được lưu lại để so sánh.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="retakeExam()" style="background: #384AD5;">
                    <i class="fas fa-play me-2"></i>Bắt đầu làm bài
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}