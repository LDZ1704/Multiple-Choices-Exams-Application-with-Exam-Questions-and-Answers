{% extends 'admin/master.html' %}

{% block title %}{{ admin_view.name }} - LmaoQuiz Admin{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
    <li class="breadcrumb-item active">{{ admin_view.name }}</li>
{% endblock %}

{% block body %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1>{{ admin_view.name }}</h1>
            <p class="text-muted mb-0">Quản lý {{ admin_view.name|lower }}</p>
        </div>
        <div class="btn-group">
            {% if admin_view.can_create %}
            <a href="{{ url_for('.create_view', url=return_url) }}" class="btn btn-primary">
                <i class="bi bi-plus-circle me-2"></i>Thêm mới
            </a>
            {% endif %}
            {% if admin_view.can_export %}
            <a href="{{ url_for('.export', export_type='csv') }}" class="btn btn-outline-success">
                <i class="bi bi-download me-2"></i>Xuất CSV
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Search and Filter Section -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                {% if search_supported %}
                <form method="GET" role="search" class="d-flex">
                    {% for flt_data in filter_groups %}
                        {% if flt_data.options %}
                            {% for opt in flt_data.options %}
                                {% if opt.selected %}
                                    <input type="hidden" name="flt{{ flt_data.index }}_{{ opt.operation }}" value="{{ opt.arg }}">
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}

                    <div class="input-group">
                        <input type="text" name="search" value="{{ search if search else '' }}" placeholder="Tìm kiếm..." class="form-control">
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-search"></i>
                        </button>
                        {% if search %}
                        <a href="{{ clear_search_url }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x"></i>
                        </a>
                        {% endif %}
                    </div>
                </form>
                {% endif %}
            </div>
            
            <div class="col-md-6">
                {% if filter_groups %}
                    <div class="d-flex justify-content-end">
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="bi bi-funnel me-2"></i>Bộ lọc
                                {% set ns = namespace(count=0) %}
                                {% for flt_data in filter_groups %}
                                    {% if flt_data.options %}
                                        {% for opt in flt_data.options %}
                                            {% if opt.selected %}
                                                {% set ns.count = ns.count + 1 %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                {% endfor %}
                                {% if ns.count > 0 %}
                                    <span class="badge bg-primary ms-1">{{ ns.count }}</span>
                                {% endif %}
                            </button>
                            <div class="dropdown-menu p-3" style="min-width: 300px;">
                                <form method="GET" id="filterForm">
                                    {% if search %}
                                    <input type="hidden" name="search" value="{{ search }}">
                                    {% endif %}

                                    {% for flt_data in filter_groups %}
                                    <div class="mb-3">
                                        <label class="form-label small text-muted fw-bold">
                                            {% if flt_data is string %}
                                                {{ admin_view.column_labels.get(flt_data, flt_data) }}
                                            {% else %}
                                                {{ admin_view.column_labels.get(flt_data.column.name, flt_data.column.name) }}
                                            {% endif %}
                                        </label>
                                        {% if flt_data.options %}
                                            {% for opt in flt_data.options %}
                                            <div class="form-check">
                                                <input class="form-check-input filter-checkbox"
                                                       type="checkbox"
                                                       name="flt{{ flt_data.index }}_{{ opt.operation }}"
                                                       value="{{ opt.arg }}"
                                                       id="filter_{{ flt_data.index }}_{{ loop.index }}"
                                                       {% if opt.selected %}checked{% endif %}>
                                                <label class="form-check-label" for="filter_{{ flt_data.index }}_{{ loop.index }}">
                                                    {{ opt.name }}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                    {% if not loop.last %}<hr class="my-2">{% endif %}
                                    {% endfor %}

                                    <div class="d-flex justify-content-between mt-3">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllFilters()">
                                            <i class="bi bi-x-circle me-1"></i>Xóa tất cả
                                        </button>
                                        <button type="submit" class="btn btn-sm btn-primary">
                                            <i class="bi bi-check-lg me-1"></i>Áp dụng
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Results Info -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="text-muted">
        Hiển thị {{ num_displayed_records }} trên {{ count }} bản ghi
        {% if search %}
        <span class="badge bg-info ms-2">Đang tìm kiếm: "{{ search }}"</span>
        {% endif %}
    </div>
    
    <div class="d-flex align-items-center">
        <label class="form-label me-2 mb-0">Hiển thị:</label>
        <select class="form-select form-select-sm" onchange="changePageSize(this.value)" style="width: 65px;">
            <option value="20" {% if page_size == 20 %}selected{% endif %}>20</option>
            <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
            <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
        </select>
    </div>
</div>

<!-- Data Table -->
<div class="card">
    <div class="card-body p-0">
        {% if data %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        {% if actions %}
                        <th width="40">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        {% endif %}
                        
                        {% for c, name in list_columns %}
                        <th class="column-header">
                            {% if admin_view.column_sortable_list and c in admin_view.column_sortable_list %}
                                {% if sort_column == c %}
                                    <a href="{{ sort_url(c, True) }}" class="text-decoration-none">
                                        {{ name }}
                                        {% if sort_desc %}
                                            <i class="bi bi-sort-down"></i>
                                        {% else %}
                                            <i class="bi bi-sort-up"></i>
                                        {% endif %}
                                    </a>
                                {% else %}
                                    <a href="{{ sort_url(c) }}" class="text-decoration-none text-dark">
                                        {{ name }}
                                        <i class="bi bi-sort text-muted"></i>
                                    </a>
                                {% endif %}
                            {% else %}
                                {{ name }}
                            {% endif %}
                        </th>
                        {% endfor %}
                        
                        {% if admin_view.column_display_actions %}
                        <th width="120" class="text-center">Thao tác</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for row in data %}
                    <tr>
                        {% if actions %}
                        <td>
                            <input type="checkbox" name="rowid" value="{{ row.id }}" class="row-checkbox">
                        </td>
                        {% endif %}

                        {% for c, name in list_columns %}
                        <td>
                            {% if admin_view.column_formatters and c in admin_view.column_formatters %}
                                {{ admin_view.column_formatters[c](admin_view, None, row, c)|safe }}
                            {% else %}
                                {% set value = row[c] %}
                                {% if value is none %}
                                    <span class="text-muted">-</span>
                                {% elif value is sameas true %}
                                    <span class="badge bg-success">Đúng</span>
                                {% elif value is sameas false %}
                                    <span class="badge bg-secondary">Sai</span>
                                {% elif value.__class__.__name__ == 'datetime' %}
                                    {{ value.strftime('%d/%m/%Y %H:%M') }}
                                {% elif value.__class__.__name__ == 'date' %}
                                    {{ value.strftime('%d/%m/%Y') }}
                                {% elif value.__class__.__name__ == 'Role' %}
                                    {% if value.name == 'ADMIN' %}
                                        <span class="badge bg-danger">Quản trị</span>
                                    {% else %}
                                        <span class="badge bg-primary">Học sinh</span>
                                    {% endif %}
                                {% else %}
                                    {% if value|string|length > 50 %}
                                        {{ value|string|truncate(50, True) }}
                                    {% else %}
                                        {{ value }}
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </td>
                        {% endfor %}

                        {% if admin_view.column_display_actions %}
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                {% if admin_view.can_view_details %}
                                <a href="{{ url_for('.details_view', id=row.id, url=return_url) }}"
                                   class="btn btn-outline-info btn-sm" title="Xem chi tiết">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% endif %}

                                {% if admin_view.can_edit %}
                                <a href="{{ url_for('.edit_view', id=row.id, url=return_url) }}"
                                   class="btn btn-outline-warning btn-sm" title="Chỉnh sửa">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                {% endif %}

                                {% if admin_view.can_delete %}
                                <form method="POST" action="{{ url_for('.delete_view') }}" class="d-inline"
                                      onsubmit="return confirm('Bạn có chắc chắn muốn xóa?')">
                                    <input type="hidden" name="id" value="{{ row.id }}">
                                    <input type="hidden" name="url" value="{{ return_url }}">
                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Xóa">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
            <h4 class="text-muted mt-3">Không có dữ liệu</h4>
            <p class="text-muted">
                {% if search %}
                Không tìm thấy kết quả nào cho "{{ search }}"
                {% else %}
                Chưa có {{ admin_view.name|lower }} nào được tạo
                {% endif %}
            </p>
            {% if admin_view.can_create and not search %}
            <a href="{{ url_for('.create_view', url=return_url) }}" class="btn btn-primary mt-3">
                <i class="bi bi-plus-circle me-2"></i>Thêm {{ admin_view.name|lower }} đầu tiên
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

<!-- Bulk Actions -->
{% if actions and data %}
<div class="card mt-3">
    <div class="card-body">
        <div class="d-flex align-items-center">
            <span class="me-3">Với các mục đã chọn:</span>
            <div class="btn-group">
                {% for p in actions %}
                <button type="button" class="btn btn-outline-secondary btn-sm" 
                        onclick="executeBulkAction('{{ p[0] }}', '{{ p[1] }}')">
                    {{ p[1] }}
                </button>
                {% endfor %}
            </div>
            <span class="ms-auto text-muted">
                <span id="selectedCount">0</span> mục đã chọn
            </span>
        </div>
    </div>
</div>
{% endif %}

<!-- Pagination -->
{% if num_pages > 1 %}
<nav class="mt-4">
    <ul class="pagination justify-content-center">
        <!-- Previous -->
        {% if page > 0 %}
        <li class="page-item">
            <a class="page-link" href="{{ pager_url(page-1) }}">
                <i class="bi bi-chevron-left"></i>
                Trước
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">
                <i class="bi bi-chevron-left"></i>
                Trước
            </span>
        </li>
        {% endif %}

        <!-- Page Numbers -->
        {% for p in page_range %}
            {% if p == page %}
            <li class="page-item active">
                <span class="page-link">{{ p + 1 }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="{{ pager_url(p) }}">{{ p + 1 }}</a>
            </li>
            {% endif %}
        {% endfor %}

        <!-- Next -->
        {% if page < num_pages - 1 %}
        <li class="page-item">
            <a class="page-link" href="{{ pager_url(page+1) }}">
                Sau
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% else %}
        <li class="page-item disabled">
            <span class="page-link">
                Sau
                <i class="bi bi-chevron-right"></i>
            </span>
        </li>
        {% endif %}
    </ul>
    
    <div class="text-center text-muted">
        Trang {{ page + 1 }} trên {{ num_pages }} ({{ count }} bản ghi)
    </div>
</nav>
{% endif %}

<script>
function applyFilter(filterIndex, operation, arg, checked) {
    const form = document.querySelector('form[role="search"]');
    const inputName = `flt${filterIndex}_${operation}`;
    const existingInput = form.querySelector(`input[name="${inputName}"]`);

    if (checked && !existingInput) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = inputName;
        input.value = arg;
        form.appendChild(input);
    } else if (!checked && existingInput) {
        existingInput.remove();
    }

    form.submit();
}

function changePageSize(size) {
    const url = new URL(window.location);
    url.searchParams.set('page_size', size);
    url.searchParams.delete('page');
    window.location = url;
}

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    const selectAll = document.getElementById('selectAll');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('.row-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = selected;
}

document.querySelectorAll('.row-checkbox').forEach(cb => {
    cb.addEventListener('change', updateSelectedCount);
});

function executeBulkAction(action, actionName) {
    const selected = document.querySelectorAll('.row-checkbox:checked');
    if (selected.length === 0) {
        alert('Vui lòng chọn ít nhất một mục');
        return;
    }

    if (confirm(`Bạn có chắc chắn muốn ${actionName} ${selected.length} mục đã chọn?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for(".action_view") }}';

        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = action;
        form.appendChild(actionInput);

        selected.forEach(cb => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'rowid';
            input.value = cb.value;
            form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}