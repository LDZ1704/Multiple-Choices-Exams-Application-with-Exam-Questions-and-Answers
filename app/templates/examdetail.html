{% extends 'layout/base.html' %}

{% block content %}
<!-- slider -->
<div class="container mb-3 p-2 shadow rounded">
    <div id="heroSlider" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="{{ url_for('static', filename='images/demo.png') }}"
                     class="d-block rounded" alt="Slide 1">
            </div>
            <div class="carousel-item">
                <img src="{{ url_for('static', filename='images/home.jpg') }}"
                     class="d-block rounded" alt="Slide 2">
            </div>
            <div class="carousel-item">
                <img src="{{ url_for('static', filename='images/login&register.jpg') }}"
                     class="d-block rounded" alt="Slide 3">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#heroSlider"
                data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#heroSlider"
                data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</div>

<!-- Th√¥ng tin ƒë·ªÅ thi -->
<div class="container bg-white shadow rounded p-4 mb-5">
    <div class="row g-4">
        <div class="col-md-3 text-center">
            <img src="{{ exam.image or url_for('static', filename='images/demo.png') }}"
                 class="img-fluid rounded border" alt="{{ exam.exam_name }}">
        </div>
        <div class="col-md-6">
            <h5 class="fw-bold">{{ exam.exam_name }}</h5>
            <div class="text-muted mb-2">T√°c gi·∫£: {{ exam.createBy if exam.createBy else '·∫®n danh' }}</div>
            <div class="mb-2">
                <i class="bi bi-calendar-event"></i> {{ exam.createAt.strftime('%d/%m/%Y') }}
            </div>
            <div class="mb-2">
                <strong>M√¥n h·ªçc:</strong> {{ exam.subject.subject_name }}
            </div>
            <div class="mb-2">
                <span class="badge bg-primary me-2">
                    <i class="bi bi-bar-chart"></i> {{ stats.avg_score }}/100
                </span>
                <span class="badge bg-info text-dark me-2">
                    <i class="bi bi-person"></i> {{ stats.total_attempts }} l∆∞·ª£t thi
                </span>
                <span class="badge bg-success">
                    <i class="bi bi-question-circle"></i> {{ question_count }} c√¢u h·ªèi
                </span>
            </div>
        </div>
        <div class="col-md-3 text-center">
            <div class="mb-2 fw-bold">Chia s·∫ª ƒë·ªÅ thi</div>
            <div class="d-flex justify-content-center mb-3">
                <a href="#" class="btn btn-outline-primary btn-sm me-1 hover-underline-center"><i class="bi bi-facebook"></i></a>
                <a href="#" class="btn btn-outline-info btn-sm me-1 hover-underline-center"><i class="bi bi-linkedin"></i></a>
                <a href="#" class="btn btn-outline-dark btn-sm hover-underline-center"><i class="bi bi-x"></i></a>
            </div>
            <div class="d-flex justify-content-center mb-3">------------------- Ho·∫∑c -------------------</div>
            <div class="d-grid gap-2 mb-2">
                <button class="btn btn-outline-secondary btn-sm hover-underline-center" onclick="copyToClipboard()">
                    <i class="bi bi-link-45deg"></i> Sao ch√©p link
                </button>
                <button class="btn btn-outline-primary btn-sm hover-underline-center" onclick="showQRCode()"><i class="bi bi-qr-code-scan"></i> Qu√©t m√£ QR</button>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12 d-grid">
            {% if current_user.is_authenticated %}
                {% set student = current_user.student %}
                {% if student %}
                    {% set existing_session = dao.get_exam_session(student.id, exam.id) %}
                    {% if existing_session and not existing_session.is_completed %}
                        <div class="notification-box notification-danger mb-3" style="color: #f0ad4e;">
                            <div class="notification-content-small">
                                <i class="fas fa-clock notification-icon-small"></i>
                                <div class="notification-text">
                                    <strong>B·∫°n c√≥ b√†i thi ch∆∞a ho√†n th√†nh!</strong>
                                    <div class="small">
                                        C√¢u ƒë√£ l√†m: {{ existing_session.user_answers|length if existing_session.user_answers else 0 }}/{{ question_count }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <a href="{{ url_for('doing_exam', exam_id=exam.id) }}" class="btn btn-warning btn-lg w-100 hover-underline-center d-flex align-items-center justify-content-center">
                                    <i class="fas fa-play me-2"></i>Ti·∫øp t·ª•c l√†m b√†i
                                </a>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-danger w-100 hover-underline-center d-flex align-items-center justify-content-center" onclick="confirmRestartExam()" style="height: 48px; font-size: 20px;">
                                    <i class="fas fa-redo me-2"></i>L√†m l·∫°i t·ª´ ƒë·∫ßu
                                </button>
                            </div>
                        </div>
                    {% elif has_result %}
                        <div class="notification-box notification-success mb-3" style="color: #155724;">
                            <div class="notification-content-small">
                                <i class="fas fa-check-circle notification-icon-small"></i>
                                <div class="notification-text">
                                    <strong>B·∫°n ƒë√£ ho√†n th√†nh b√†i thi n√†y!</strong>
                                    <div class="small-text">ƒêi·ªÉm s·ªë cao nh·∫•t: {{ highest_score }}/100</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                {% set latest_result = user_results[0] if user_results else None %}
                                {% if latest_result %}
                                    <a href="{{ url_for('view_exam_result', result_id=latest_result.id) }}"
                                       class="btn btn-primary btn-lg w-100 hover-underline-center" style="background: #384AD5;">
                                        <i class="fas fa-eye me-2"></i>Xem k·∫øt qu·∫£
                                    </a>
                                {% endif %}
                            </div>
                            <div class="col-6">
                                <a class="btn btn-outline-primary btn-lg w-100 hover-underline-center" onclick="confirmRetakeExam()">
                                    <i class="fas fa-redo me-2"></i>B·∫Øt ƒë·∫ßu √¥n thi l·∫°i
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <a href="{{ url_for('doing_exam', exam_id=exam.id) }}"
                           class="btn fs-5 text-white text-decoration-none hover-underline-center mb-3" style="background: #384AD5;">
                            <i class="bi bi-play-circle"></i> B·∫Øt ƒë·∫ßu √¥n thi
                        </a>
                    {% endif %}
                {% endif %}
            {% else %}
                <a href="{{ url_for('login', next=url_for('exam_detail', id=exam.id)) }}"
                   class="btn fs-5 text-white text-decoration-none hover-underline-center mb-3" style="background: #384AD5;">
                    <i class="bi bi-play-circle"></i> B·∫Øt ƒë·∫ßu √¥n thi
                </a>
            {% endif %}
        </div>
    </div>

    <div class="notification-box notification-warning mt-2">
        <div class="notification-content-small">
            <i class="bi bi-info-circle-fill notification-icon-small"></i>
            <div class="notification-text small-text">
                T√†i li·ªáu √¥n thi ch·ªâ c√≥ gi√° tr·ªã tham kh·∫£o v√† √¥n t·∫≠p, kh√¥ng ph·∫£i ƒë·ªÅ thi th·ª±c t·∫ø.
            </div>
        </div>
    </div>

    {% if current_user.is_authenticated %}
    <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #384AD5 0%, #5a67d8 100%);">
        <div class="card-body text-white">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-star me-2"></i>ƒê√°nh gi√° ƒë·ªÅ thi n√†y
                    </h5>

                    {% if has_result %}
                        <div id="rating-container">
                            <p class="mb-2 opacity-75">Tr·∫£i nghi·ªám c·ªßa b·∫°n nh∆∞ th·∫ø n√†o?</p>
                            <div class="star-rating mb-3" id="star-rating">
                                <span class="star" data-rating="1">‚òÖ</span>
                                <span class="star" data-rating="2">‚òÖ</span>
                                <span class="star" data-rating="3">‚òÖ</span>
                                <span class="star" data-rating="4">‚òÖ</span>
                                <span class="star" data-rating="5">‚òÖ</span>
                            </div>
                            <div id="rating-message" class="rating-message" style="display: none;"></div>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 fs-5"></i>
                            <span>Ho√†n th√†nh b√†i thi ƒë·ªÉ ƒë√°nh gi√°</span>
                        </div>
                    {% endif %}
                </div>

                <div class="col-md-4 text-center">
                    <div class="rating-stats-card">
                        <div class="mb-2">
                            <div id="average-stars" class="star-display justify-content-center mb-1"></div>
                            <div class="fs-4 fw-bold">
                                <span id="average-rating-text">0.0</span><small class="fs-6 opacity-75">/5</small>
                            </div>
                            <div id="rating-summary" class="small opacity-75">(0 ƒë√°nh gi√°)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Hi·ªÉn th·ªã th·ªëng k√™ rating cho user ch∆∞a ƒëƒÉng nh·∫≠p -->
    <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title text-dark mb-2">
                        <i class="fas fa-star text-warning me-2"></i>ƒê√°nh gi√° t·ª´ c·ªông ƒë·ªìng
                    </h5>
                    <p class="text-muted mb-0">
                        <a href="{{ url_for('login', next=url_for('exam_detail', id=exam.id)) }}" class="text-decoration-none">ƒêƒÉng nh·∫≠p</a>
                        ƒë·ªÉ ƒë√°nh gi√° ƒë·ªÅ thi n√†y
                    </p>
                </div>

                <div class="col-md-4 text-center">
                    <div class="rating-stats-card">
                        <div class="mb-2">
                            <div id="average-stars" class="star-display justify-content-center mb-1"></div>
                            <div class="fs-4 fw-bold text-dark">
                                <span id="average-rating-text">0.0</span><small class="fs-6 text-muted">/5</small>
                            </div>
                            <div id="rating-summary" class="small opacity-75">(0 ƒë√°nh gi√°)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Tab content -->
<div class="container">
    <div class="card shadow-sm p-4 mb-5">
        <div class="card-body">
            <ul class="nav nav-tabs mb-3" id="examTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#reviews" id="reviews-tab">
                        B√¨nh lu·∫≠n ({{ comments_pagination.total }})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#ranking" id="ranking-tab">
                        X·∫øp h·∫°ng ({{ ranking_stats.total_participants if ranking_stats else 0 }})
                    </a>
                </li>
                {% if current_user.is_authenticated %}
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#results" id="results-tab">
                        K·∫øt qu·∫£ √¥n t·∫≠p ({{ user_results|length if user_results else 0 }})
                    </a>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content">
                <!-- Tab b√¨nh lu·∫≠n -->
                <div class="tab-pane fade show active" id="reviews">
                    <div class="card-header d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-comments"></i> B√¨nh lu·∫≠n & ƒê√°nh gi√°
                            </h5>
                            <small class="text-muted">
                                <span id="comments-count">{{ comments_pagination.total }}</span> b√¨nh lu·∫≠n,
                                <span id="ratings-count">{{ rating_stats.total_ratings }}</span> ƒë√°nh gi√°
                                {% if rating_stats.total_ratings > 0 %}
                                    ‚Ä¢ Trung b√¨nh:
                                    <span class="text-warning">
                                        {% for i in range(1, 6) %}
                                            {% if i <= rating_stats.average_rating|round %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </span>
                                    <span class="fw-bold">{{ rating_stats.average_rating }}</span>/5
                                {% endif %}
                            </small>
                        </div>
                    </div>

                    {% if current_user.is_authenticated %}
                    <div class="card mb-4 border-primary">
                        <div class="card-body">
                            <h6 class="card-title">Vi·∫øt b√¨nh lu·∫≠n</h6>
                            <form method="POST" action="{{ url_for('add_exam_comment') }}">
                                <input type="hidden" name="exam_id" value="{{ exam.id }}">
                                <div class="mb-3">
                                    <textarea class="form-control" name="content" rows="3" placeholder="Chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n v·ªÅ ƒë·ªÅ thi n√†y..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary hover-underline-center" style="background-color: #384AD5;">G·ª≠i b√¨nh lu·∫≠n</button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div class="notification-box notification-info">
                        <div class="notification-content-small">
                            <i class="bi bi-info-circle notification-icon-small"></i>
                            <div class="notification-text">
                                <a href="{{ url_for('login', next=url_for('exam_detail', id=exam.id)) }}" class="login-link">ƒêƒÉng nh·∫≠p</a>
                                ƒë·ªÉ vi·∫øt ƒë√°nh gi√° v√† xem k·∫øt qu·∫£ √¥n t·∫≠p.
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Danh s√°ch b√¨nh lu·∫≠n -->
                    {% if comments_pagination.items %}
                    {% for comment in comments_pagination.items %}
                        <div class="card mb-3 border border-light shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <img src="{{ comment.user.avatar or url_for('static', filename='images/demo.png') }}"
                                             class="img-fluid rounded-circle me-3"
                                             style="width: 3rem; height: 3rem;" alt="avatar">
                                        <div>
                                            <div class="d-flex align-items-center gap-2">
                                                <strong>{{ comment.user.name }}</strong>
                                                <div class="user-rating" data-user-id="{{ comment.user.id }}"></div>
                                            </div>
                                            <small class="text-muted">{{ 'Qu·∫£n tr·ªã vi√™n' if comment.user.role.name == 'ADMIN' else 'H·ªçc sinh' }}</small>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        {{ comment.created_at.strftime('%H:%M - %d/%m/%Y') }}
                                    </small>
                                </div>
                                <div class="text-body">
                                    <p class="mb-0">{{ comment.content }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Ph√¢n trang ƒë√°nh gi√° -->
                    {% if comments_pagination.pages > 1 %}
                    <nav aria-label="Comments pagination" id="comments-pagination">
                        <ul class="pagination justify-content-center">
                            {% if comments_pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?id={{ exam.id }}&comment_page={{ comments_pagination.prev_num }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for page_num in comments_pagination.iter_pages() %}
                            {% if page_num %}
                            {% if page_num != comments_pagination.page %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?id={{ exam.id }}&comment_page={{ page_num }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">‚Ä¶</span>
                            </li>
                            {% endif %}
                            {% endfor %}

                            {% if comments_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?id={{ exam.id }}&comment_page={{ comments_pagination.next_num }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-chat-dots fs-1"></i>
                        <p class="mt-2">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho ƒë·ªÅ thi n√†y.</p>
                        {% if current_user.is_authenticated %}
                        <p>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒë√°nh gi√°!</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Tab B·∫£ng x·∫øp h·∫°ng -->
                <div class="tab-pane fade" id="ranking">

                    <!-- Th√¥ng b√°o cho ng∆∞·ªùi t·∫°o ƒë·ªÅ -->
                    {% if current_user.is_authenticated and current_user.id == exam.user_id %}
                    <div class="alert alert-info border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <i class="bi bi-person-check-fill text-primary fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading fw-bold text-primary mb-2 fs-5">
                                    <i class="bi bi-trophy me-1"></i>Th√¥ng b√°o cho ng∆∞·ªùi t·∫°o ƒë·ªÅ
                                </h6>
                                <p class="mb-1 text-dark">
                                    B·∫°n l√† ng∆∞·ªùi t·∫°o ra ƒë·ªÅ thi n√†y, v√¨ v·∫≠y <strong>k·∫øt qu·∫£ c·ªßa b·∫°n s·∫Ω kh√¥ng ƒë∆∞·ª£c hi·ªÉn th·ªã trong b·∫£ng x·∫øp h·∫°ng</strong>
                                    ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh c√¥ng b·∫±ng cho c√°c th√≠ sinh kh√°c.
                                </p>
                                <small class="text-primary">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    B·∫°n v·∫´n c√≥ th·ªÉ l√†m b√†i ƒë·ªÉ ki·ªÉm tra ƒë·ªÅ thi v√† xem k·∫øt qu·∫£ trong m·ª•c "K·∫øt qu·∫£ √¥n t·∫≠p".
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- √î ch√∫ th√≠ch v·ªÅ quy t·∫Øc x·∫øp h·∫°ng -->
                    <div class="alert alert-info border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <i class="bi bi-info-circle-fill text-primary fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading fw-bold text-primary mb-2 fs-5">
                                    <i class="bi bi-trophy me-1"></i>Quy t·∫Øc x·∫øp h·∫°ng
                                </h6>
                                <ul class="mb-1 text-dark">
                                    <li>B·∫£ng x·∫øp h·∫°ng ch·ªâ t√≠nh <strong>l·∫ßn l√†m b√†i ƒë·∫ßu ti√™n</strong> c·ªßa th√≠ sinh</li>
                                    <li><strong>Ng∆∞·ªùi t·∫°o ƒë·ªÅ thi kh√¥ng tham gia x·∫øp h·∫°ng</strong> ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh c√¥ng b·∫±ng</li>
                                    <li>X·∫øp h·∫°ng theo ƒëi·ªÉm s·ªë cao nh·∫•t, n·∫øu b·∫±ng nhau th√¨ ∆∞u ti√™n ng∆∞·ªùi l√†m tr∆∞·ªõc</li>
                                </ul>
                                <small class="text-primary">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    ƒêi·ªÅu n√†y ƒë·∫£m b·∫£o t√≠nh c√¥ng b·∫±ng v√† ch·∫•t l∆∞·ª£ng c·ªßa b·∫£ng x·∫øp h·∫°ng.
                                </small>
                            </div>
                        </div>
                    </div>

                    {% if ranking_stats and ranking_stats.total_participants > 0 %}
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-center bg-light">
                                <div class="card-body">
                                    <i class="bi bi-people-fill text-info fs-2"></i>
                                    <h5 class="card-title mt-2">{{ ranking_stats.total_participants }}</h5>
                                    <p class="card-text text-muted">Th√≠ sinh tham gia</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center bg-light">
                                <div class="card-body">
                                    <i class="bi bi-graph-up text-success fs-2"></i>
                                    <h5 class="card-title mt-2">{{ ranking_stats.avg_score }}/100</h5>
                                    <p class="card-text text-muted">ƒêi·ªÉm trung b√¨nh</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center bg-light">
                                <div class="card-body">
                                    <i class="bi bi-trophy-fill text-warning fs-2"></i>
                                    <h5 class="card-title mt-2">{{ ranking_stats.highest_score }}/100</h5>
                                    <p class="card-text text-muted">ƒêi·ªÉm cao nh·∫•t</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 3 Podium -->
                    {% if ranking_pagination.items|length >= 3 %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-center mb-3">üèÜ Top 3 Xu·∫•t S·∫Øc</h5>
                            <div class="podium-container">
                                <div class="podium-item second-place">
                                    <img src="{{ ranking_pagination.items[1].avatar or url_for('static', filename='images/demo.png') }}"
                                         class="podium-avatar" alt="Avatar">
                                    <h6>{{ ranking_pagination.items[1].name }}</h6>
                                    <div class="podium-score">{{ ranking_pagination.items[1].score }}/100</div>
                                    <div class="podium-rank">
                                        <i class="bi bi-award-fill"></i>
                                        <span>2</span>
                                    </div>
                                </div>
                                <div class="podium-item first-place">
                                    <img src="{{ ranking_pagination.items[0].avatar or url_for('static', filename='images/demo.png') }}"
                                         class="podium-avatar" alt="Avatar">
                                    <h6>{{ ranking_pagination.items[0].name }}</h6>
                                    <div class="podium-score">{{ ranking_pagination.items[0].score }}/100</div>
                                    <div class="podium-rank">
                                        <i class="bi bi-trophy-fill"></i>
                                        <span>1</span>
                                    </div>
                                </div>
                                <div class="podium-item third-place">
                                    <img src="{{ ranking_pagination.items[2].avatar or url_for('static', filename='images/demo.png') }}"
                                         class="podium-avatar" alt="Avatar">
                                    <h6>{{ ranking_pagination.items[2].name }}</h6>
                                    <div class="podium-score">{{ ranking_pagination.items[2].score }}/100</div>
                                    <div class="podium-rank">
                                        <i class="bi bi-award-fill"></i>
                                        <span>3</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- B·∫£ng x·∫øp h·∫°ng ƒë·∫ßy ƒë·ªß -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="80">H·∫°ng</th>
                                    <th>Th√≠ sinh</th>
                                    <th width="100">ƒêi·ªÉm s·ªë</th>
                                    <th width="200">Ng√†y thi</th>
                                    <th width="150">Th·ªùi gian thi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for participant in ranking_pagination.items %}
                                <tr class="{% if current_user.is_authenticated and current_user.student and current_user.student.id == participant.student_id %}table-warning{% endif %}">
                                    <td>
                                        <div class="rank-badge">
                                            {% if participant.rank <= 5 %}
                                                {% if participant.rank == 1 %}
                                                    <i class="bi bi-trophy-fill text-warning"></i>
                                                {% elif participant.rank == 2 %}
                                                    <i class="bi bi-award-fill text-secondary"></i>
                                                {% elif participant.rank == 3 %}
                                                    <i class="bi bi-award-fill text-warning"></i>
                                                {% elif participant.rank == 4 %}
                                                    <i class="bi bi-star-fill text-primary"></i>
                                                {% elif participant.rank == 5 %}
                                                    <i class="bi bi-star-fill text-info"></i>
                                                {% endif %}
                                            {% endif %}
                                            <span class="ms-1">#{{ participant.rank }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ participant.avatar or url_for('static', filename='images/demo.png') }}" class="rounded-circle me-2" style="width: 32px; height: 32px;" alt="Avatar">
                                            <div>
                                                <span class="fw-bold">{{ participant.name }}</span>
                                                {% if current_user.is_authenticated and current_user.student and current_user.student.id == participant.student_id %}
                                                    <small class="text-primary d-block">B·∫°n</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {% if participant.score >= 80 %}bg-success{% elif participant.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ participant.score }}/100
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ participant.taken_exam.strftime('%d/%m/%Y l√∫c %H:%M:%S') }}</small>
                                    </td>
                                    <td>
                                        <span>
                                            {% if participant.time_taken %}
                                                {% set minutes = (participant.time_taken // 60) %}
                                                {% set seconds = (participant.time_taken % 60) %}
                                                {% if minutes > 0 %}
                                                    {{ minutes }} ph√∫t {% if seconds > 0 %}{{ seconds }} gi√¢y{% endif %}
                                                {% else %}
                                                    {{ seconds }} gi√¢y
                                                {% endif %}
                                            {% else %}
                                                --
                                            {% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Ph√¢n trang x·∫øp h·∫°ng -->
                    {% if ranking_pagination.pages > 1 %}
                    <nav aria-label="Ranking pagination" class="mt-3">
                        <ul class="pagination justify-content-center">
                            {% if ranking_pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="?id={{ exam.id }}&ranking_page={{ ranking_pagination.prev_num }}#ranking" onclick="switchToRankingTab()">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for page_num in ranking_pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != ranking_pagination.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="?id={{ exam.id }}&ranking_page={{ page_num }}#ranking" onclick="switchToRankingTab()">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">‚Ä¶</span>
                                </li>
                                {% endif %}
                            {% endfor %}

                            {% if ranking_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?id={{ exam.id }}&ranking_page={{ ranking_pagination.next_num }}#ranking" onclick="switchToRankingTab()">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-trophy fs-1 text-muted"></i>
                        <p class="mt-2 text-muted">
                            {% if current_user.is_authenticated and current_user.id == exam.createBy_id %}
                                Ch∆∞a c√≥ th√≠ sinh n√†o l√†m b√†i thi n√†y. H√£y chia s·∫ª ƒë·ªÅ thi ƒë·ªÉ m·ªçi ng∆∞·ªùi c√πng tham gia!
                            {% else %}
                                Ch∆∞a c√≥ th√≠ sinh n√†o l√†m b√†i thi n√†y.
                            {% endif %}
                        </p>
                        {% if current_user.is_authenticated and current_user.id != exam.user_id %}
                        <a href="{{ url_for('doing_exam', exam_id=exam.id) }}" class="btn text-white text-decoration-none hover-underline-center" style="background: #384AD5;">
                            <i class="bi bi-play-circle"></i> H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Tab K·∫øt qu·∫£ √¥n t·∫≠p -->
                {% if current_user.is_authenticated %}
                <div class="tab-pane fade" id="results">
                    {% if user_results %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                            <tr>
                                <th>L·∫ßn thi</th>
                                <th>ƒêi·ªÉm s·ªë</th>
                                <th>Th·ªùi gian ƒë√£ l√†m b√†i</th>
                                <th>Ng√†y thi</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>H√†nh ƒë·ªông</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for result in user_results %}
                            <tr>
                                <td>{{ loop.revindex }}</td>
                                <td>
                                    <span class="badge {% if result.score >= 80 %}bg-success{% elif result.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ result.score }}/100
                                    </span>
                                </td>
                                <td>
                                    {% if result.time_taken %}
                                        {% set minutes = (result.time_taken // 60) %}
                                        {% set seconds = (result.time_taken % 60) %}
                                        {% if minutes > 0 %}
                                            {{ minutes }} ph√∫t {% if seconds > 0 %}{{ seconds }} gi√¢y{% endif %}
                                        {% else %}
                                            {{ seconds }} gi√¢y
                                        {% endif %}
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                                <td>{{ result.taken_exam.strftime('%H:%M:%S %d/%m/%Y') }}</td>
                                <td>
                                    {% if result.score >= 50 %}
                                    <span class="text-success">ƒê·∫°t</span>
                                    {% else %}
                                    <span class="text-danger">Kh√¥ng ƒë·∫°t</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('view_exam_result', result_id=result.id) }}"
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> Xem chi ti·∫øt
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Th·ªëng k√™ c√° nh√¢n -->
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">{{ user_results|length }}</h5>
                                    <p class="card-text">S·ªë l·∫ßn thi</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-success">
                                        {% if user_results|length > 0 %}
                                        {{ "%.1f"|format((user_results|sum(attribute='score'))/user_results|length)
                                        }}/100
                                        {% else %}
                                        0/100
                                        {% endif %}
                                    </h5>
                                    <p class="card-text">ƒêi·ªÉm trung b√¨nh</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-warning">
                                        {{ user_results|selectattr('score', '>=', 5)|list|length }}
                                    </h5>
                                    <p class="card-text">S·ªë l·∫ßn ƒë·∫°t</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-graph-up fs-1"></i>
                        <p class="mt-2">B·∫°n ch∆∞a thi ƒë·ªÅ n√†y.</p>
                        <a href="{{ url_for('doing_exam', exam_id=exam.id) }}" class="btn text-white text-decoration-none hover-underline-center" style="background: #384AD5;">
                            <i class="bi bi-play-circle"></i> B·∫Øt ƒë·∫ßu thi ngay
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal x√°c nh·∫≠n l√†m l·∫°i l√∫c c√≤n ƒëang l√†m -->
<div class="modal fade" id="restartExamModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0"
                 style="background: linear-gradient(135deg, #ff416c 0%, #ff4757 100%);">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-redo me-2"></i>X√°c nh·∫≠n l√†m l·∫°i t·ª´ ƒë·∫ßu
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l√†m l·∫°i b√†i thi kh√¥ng?</h5>
                    <p class="text-muted">To√†n b·ªô ti·∫øn tr√¨nh hi·ªán t·∫°i s·∫Ω b·ªã x√≥a v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c.</p>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <div class="text-center p-3 bg-success bg-opacity-10 rounded-3">
                            <i class="fas fa-check-circle text-white fs-3 mb-2"></i>
                            <h3 class="mb-0 text-white fw-bold" id="restart-answered-count">0</h3>
                            <small class="text-white">C√¢u ƒë√£ l√†m</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3 bg-warning bg-opacity-10 rounded-3">
                            <i class="fas fa-trash-alt text-danger fs-3 mb-2"></i>
                            <h3 class="mb-0 text-danger fw-bold">S·∫º M·∫§T</h3>
                            <small class="text-danger">Ti·∫øn tr√¨nh</small>
                        </div>
                    </div>
                </div>

                <!-- Th√™m th√¥ng tin th·ªùi gian ƒë√£ d√πng (n·∫øu c√≥) -->
                <div class="alert alert-warning mt-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2"></i>
                        <div>
                            <strong>Th·ªùi gian ƒë√£ l√†m b√†i:</strong>
                            <span id="restart-time-used">0 ph√∫t</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-danger rounded-pill px-4" data-exam-id="{{ exam.id }}" data-answered-count="{{ session.user_answers|length if session.user_answers else 0 }}" onclick="restartExam()">
                    <i class="fas fa-redo me-2"></i>L√†m l·∫°i t·ª´ ƒë·∫ßu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal x√°c nh·∫≠n l√†m l·∫°i b√†i thi sau khi l√†m 1 l·∫ßn -->
<div class="modal fade" id="retakeExamModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0"
                 style="background: linear-gradient(135deg, #384AD5 0%, #5a67d8 100%);">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-redo me-2"></i>B·∫Øt ƒë·∫ßu √¥n thi l·∫°i
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-question-circle text-primary fs-1 mb-3"></i>
                    <h5 class="fw-bold">B·∫°n c√≥ mu·ªën l√†m l·∫°i b√†i thi n√†y kh√¥ng?</h5>
                    <p class="text-muted">B·∫°n s·∫Ω t·∫°o m·ªôt phi√™n thi m·ªõi v√† c√≥ th·ªÉ c·∫£i thi·ªán ƒëi·ªÉm s·ªë c·ªßa m√¨nh.</p>
                </div>

                <div class="notification-box notification-info">
                    <div class="notification-content-small">
                        <i class="bi bi-info-circle notification-icon-small"></i>
                        <div class="notification-text small-text">
                            ƒêi·ªÉm s·ªë cao nh·∫•t c·ªßa b·∫°n s·∫Ω ƒë∆∞·ª£c l∆∞u l·∫°i ƒë·ªÉ so s√°nh.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="retakeExam()" style="background: #384AD5;">
                    <i class="fas fa-play me-2"></i>B·∫Øt ƒë·∫ßu l√†m b√†i
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal QR Code -->
<div class="modal fade" id="qrCodeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0"
                 style="background: linear-gradient(135deg, #384AD5 0%, #5a67d8 100%);">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-qr-code me-2"></i>M√£ QR ƒê·ªÅ Thi
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div id="qr-loading" class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫°o m√£ QR...</span>
                    </div>
                    <p class="mt-2">ƒêang t·∫°o m√£ QR...</p>
                </div>

                <div id="qr-content" style="display: none;">
                    <div class="mb-3">
                        <img id="qr-image" src="" alt="QR Code" class="img-fluid" style="max-width: 250px;">
                    </div>
                    <h6 id="qr-exam-name" class="fw-bold mb-2 fs-3"></h6>
                    <p class="text-muted mb-3">Qu√©t m√£ QR ƒë·ªÉ truy c·∫≠p ƒë·ªÅ thi</p>

                    <div class="input-group mb-3">
                        <input type="text" id="qr-url" class="form-control" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyQRUrl()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>

                <div id="qr-error" style="display: none;" class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="qr-error-message">C√≥ l·ªói x·∫£y ra khi t·∫°o m√£ QR</span>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                    <i class="bi bi-x me-2"></i>ƒê√≥ng
                </button>
                <button type="button" id="download-qr" class="btn btn-primary rounded-pill px-4" style="background: #384AD5; display: none;">
                    <i class="bi bi-download me-2"></i>T·∫£i xu·ªëng
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/rating.js') }}"></script>
<script>
    const userAnswers = {{ (existing_session.user_answers | tojson) if existing_session and existing_session.user_answers else '{}' }};
    window.sessionData = {
        user_answers: userAnswers
    };

    function confirmRestartExam() {
        updateRestartModalStats();

        const modal = new bootstrap.Modal(document.getElementById('restartExamModal'));
        modal.show();
    }

    function updateRestartModalStats() {
        const answeredCount = (typeof userAnswers !== 'undefined' && userAnswers)
            ? Object.keys(userAnswers).length
            : (window.sessionData && window.sessionData.user_answers)
                ? Object.keys(window.sessionData.user_answers).length
                : 0;

        document.getElementById('restart-answered-count').textContent = answeredCount;

        const examDuration = {{ exam.duration }};

        {% if session and session.start_time %}
            const startTime = new Date('{{ session.start_time.isoformat() }}');
            {% if session.is_paused and session.pause_time%}
                const endTime = new Date('{{ session.pause_time.isoformat() }}');
                const totalElapsedSeconds = Math.floor((endTime - startTime) / 1000);

                const pausedDuration = {{ session.total_paused_duration or 0 }};
                const actualUsedTime = Math.max(0, totalElapsedSeconds - pausedDuration);

                const usedMinutes = Math.floor(actualUsedTime / 60);
                const usedSeconds = actualUsedTime % 60;
            {% else %}
                const actualUsedTime = 0;
            {% endif %}
            let timeText = '';
            if (usedMinutes > 0) {
                timeText = `${usedMinutes} ph√∫t`;
                if (usedSeconds > 0) {
                    timeText += ` ${usedSeconds} gi√¢y`;
                }
            } else {
                timeText = `${Math.max(0, usedSeconds)} gi√¢y`;
            }
            
            document.getElementById('restart-time-used').textContent = timeText;

            const timeAlert = document.querySelector('#restartExamModal .alert-warning');
            if (timeAlert) {
                timeAlert.style.display = 'block';
            }
        {% else %}
            const timeAlert = document.querySelector('#restartExamModal .alert-warning');
            if (timeAlert) {
                timeAlert.style.display = 'none';
            }
        {% endif %}
    }

    function restartExam() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('restartExamModal'));
        modal.hide();

        const examId = getExamId();

        if (!examId) {
            alert('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh b√†i thi!');
            return;
        }

        showLoadingOverlay('ƒêang reset b√†i thi...', 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t');

        fetch(`/api/exam/${examId}/restart`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/doing-exam/${examId}?restart=1`;
            } else {
                showErrorOverlay('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ reset b√†i thi'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorOverlay('Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß');
        });
    }

    function getExamId() {
        if (typeof examId !== 'undefined') return examId;

        const urlParams = new URLSearchParams(window.location.search);
        const urlExamId = urlParams.get('id') || urlParams.get('exam_id');
        if (urlExamId) return urlExamId;

        const pathMatch = window.location.pathname.match(/doing-exam\/(\d+)/);
        if (pathMatch) return pathMatch[1];

        const examElement = document.querySelector('[data-exam-id]');
        if (examElement) return examElement.dataset.examId;

        return null;
    }

    function showLoadingOverlay(title, message) {
        const container = document.querySelector('.container-fluid') || document.body;
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">${title}</span>
                </div>
                <h4>${title}</h4>
                <p class="text-muted">${message}</p>
            </div>
        `;
    }

    function showErrorOverlay(errorMessage) {
        const container = document.querySelector('.container-fluid') || document.body;
        container.innerHTML = `
            <div class="alert alert-danger text-center py-5">
                <i class="fas fa-exclamation-triangle fs-1 mb-3"></i>
                <h4>${errorMessage}</h4>
                <button class="btn btn-primary mt-3" onclick="window.location.reload()">
                    <i class="fas fa-redo me-2"></i>Th·ª≠ l·∫°i
                </button>
            </div>
        `;
    }

    function confirmRetakeExam() {
        const modal = new bootstrap.Modal(document.getElementById('retakeExamModal'));
        modal.show();
    }

    function retakeExam() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('retakeExamModal'));
        modal.hide();

        const examId = getExamId();

        if (!examId) {
            alert('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh b√†i thi!');
            return;
        }

        showLoadingOverlay('ƒêang kh·ªüi t·∫°o b√†i thi m·ªõi...', 'Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t');

        window.location.href = `/doing-exam/${examId}`;
    }

    function switchToRankingTab() {
        document.getElementById('ranking-tab').click();
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (window.location.hash === '#ranking') {
            document.getElementById('ranking-tab').click();
        }
    });

    function showQRCode() {
        const examId = getExamId();
        if (!examId) {
            alert('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh b√†i thi!');
            return;
        }

        const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
        modal.show();

        document.getElementById('qr-loading').style.display = 'block';
        document.getElementById('qr-content').style.display = 'none';
        document.getElementById('qr-error').style.display = 'none';
        document.getElementById('download-qr').style.display = 'none';

        fetch(`/api/exam/${examId}/qr-code`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('qr-loading').style.display = 'none';

                if (data.success) {
                    document.getElementById('qr-image').src = data.qr_image;
                    document.getElementById('qr-exam-name').textContent = data.exam_name;
                    document.getElementById('qr-url').value = data.exam_url;
                    document.getElementById('qr-content').style.display = 'block';
                    document.getElementById('download-qr').style.display = 'inline-block';

                    window.qrData = data.qr_image;
                } else {
                    document.getElementById('qr-error-message').textContent = data.error || 'C√≥ l·ªói x·∫£y ra khi t·∫°o m√£ QR';
                    document.getElementById('qr-error').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('qr-loading').style.display = 'none';
                document.getElementById('qr-error-message').textContent = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi t·ªõi m√°y ch·ªß';
                document.getElementById('qr-error').style.display = 'block';
            });
    }

    function copyQRUrl() {
        const urlInput = document.getElementById('qr-url');
        urlInput.select();
        urlInput.setSelectionRange(0, 99999);

        try {
            document.execCommand('copy');
            const originalText = urlInput.nextElementSibling.innerHTML;
            urlInput.nextElementSibling.innerHTML = '<i class="bi bi-check text-success"></i>';
            setTimeout(() => {
                urlInput.nextElementSibling.innerHTML = originalText;
            }, 1000);
        } catch (err) {
            console.error('Kh√¥ng th·ªÉ sao ch√©p: ', err);
        }
    }

    document.getElementById('download-qr').addEventListener('click', function() {
        if (window.qrData) {
            const link = document.createElement('a');
            link.download = 'exam-qr-code.png';
            link.href = window.qrData;
            link.click();
        }
    });
</script>

{% endblock %}