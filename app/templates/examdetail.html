{% extends 'layout/base.html' %}

{% block content %}
<!-- slider -->
<div class="container mb-3 p-2 shadow rounded">
    <div id="heroSlider" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="{{ url_for('static', filename='images/demo.png') }}"
                     class="d-block rounded" alt="Slide 1">
            </div>
            <div class="carousel-item">
                <img src="{{ url_for('static', filename='images/home.jpg') }}"
                     class="d-block rounded" alt="Slide 2">
            </div>
            <div class="carousel-item">
                <img src="{{ url_for('static', filename='images/login&register.jpg') }}"
                     class="d-block rounded" alt="Slide 3">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#heroSlider"
                data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#heroSlider"
                data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</div>

<!-- Thông tin đề thi -->
<div class="container bg-white shadow rounded p-4 mb-5">
    <div class="row g-4">
        <div class="col-md-3 text-center">
            <img src="{{ exam.image or url_for('static', filename='images/demo.png') }}"
                 class="img-fluid rounded border" alt="{{ exam.exam_name }}">
        </div>
        <div class="col-md-6">
            <h5 class="fw-bold">{{ exam.exam_name }}</h5>
            <div class="text-muted mb-2">Tác giả: {{ exam.createBy if exam.createBy else 'Ẩn danh' }}</div>
            <div class="mb-2">
                <i class="bi bi-calendar-event"></i> {{ exam.createAt.strftime('%d/%m/%Y') }}
            </div>
            <div class="mb-2">
                <strong>Môn học:</strong> {{ exam.subject.subject_name }}
            </div>
            <div class="mb-2">
                <span class="badge bg-primary me-2">
                    <i class="bi bi-bar-chart"></i> {{ stats.avg_score }}/100
                </span>
                <span class="badge bg-info text-dark me-2">
                    <i class="bi bi-person"></i> {{ stats.total_attempts }} lượt thi
                </span>
                <span class="badge bg-success">
                    <i class="bi bi-question-circle"></i> {{ question_count }} câu hỏi
                </span>
            </div>
        </div>
        <div class="col-md-3 text-center">
            <div class="mb-2 fw-bold">Chia sẻ đề thi</div>
            <div class="d-flex justify-content-center mb-3">
                <a href="#" class="btn btn-outline-primary btn-sm me-1 hover-underline-center"><i class="bi bi-facebook"></i></a>
                <a href="#" class="btn btn-outline-info btn-sm me-1 hover-underline-center"><i class="bi bi-linkedin"></i></a>
                <a href="#" class="btn btn-outline-dark btn-sm hover-underline-center"><i class="bi bi-x"></i></a>
            </div>
            <div class="d-flex justify-content-center mb-3">------------------- Hoặc -------------------</div>
            <div class="d-grid gap-2 mb-2">
                <button class="btn btn-outline-secondary btn-sm hover-underline-center" onclick="copyToClipboard()">
                    <i class="bi bi-link-45deg"></i> Sao chép link
                </button>
                <button class="btn btn-outline-primary btn-sm hover-underline-center" onclick="showQRCode()"><i class="bi bi-qr-code-scan"></i> Quét mã QR</button>
            </div>
        </div>
    </div>
    <div class="row mt-4">
        <div class="col-md-12 d-grid">
            {% if current_user.is_authenticated %}
                {% set student = current_user.student %}
                {% if student %}
                    {% set existing_session = dao.get_exam_session(student.id, exam.id) %}
                    {% if existing_session and not existing_session.is_completed %}
                        <div class="notification-box notification-danger mb-3" style="color: #f0ad4e;">
                            <div class="notification-content-small">
                                <i class="fas fa-clock notification-icon-small"></i>
                                <div class="notification-text">
                                    <strong>Bạn có bài thi chưa hoàn thành!</strong>
                                    <div class="small">
                                        Câu đã làm: {{ existing_session.user_answers|length if existing_session.user_answers else 0 }}/{{ question_count }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <a href="{{ url_for('doing_exam', exam_id=exam.id) }}" class="btn btn-warning btn-lg w-100 hover-underline-center d-flex align-items-center justify-content-center">
                                    <i class="fas fa-play me-2"></i>Tiếp tục làm bài
                                </a>
                            </div>
                            <div class="col-6">
                                <button type="button" class="btn btn-outline-danger w-100 hover-underline-center d-flex align-items-center justify-content-center" onclick="confirmRestartExam()" style="height: 48px; font-size: 20px;">
                                    <i class="fas fa-redo me-2"></i>Làm lại từ đầu
                                </button>
                            </div>
                        </div>
                    {% elif has_result %}
                        <div class="notification-box notification-success mb-3" style="color: #155724;">
                            <div class="notification-content-small">
                                <i class="fas fa-check-circle notification-icon-small"></i>
                                <div class="notification-text">
                                    <strong>Bạn đã hoàn thành bài thi này!</strong>
                                    <div class="small-text">Điểm số cao nhất: {{ highest_score }}/100</div>
                                </div>
                            </div>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                {% set latest_result = user_results[0] if user_results else None %}
                                {% if latest_result %}
                                    <a href="{{ url_for('view_exam_result', result_id=latest_result.id) }}"
                                       class="btn btn-primary btn-lg w-100 hover-underline-center" style="background: #384AD5;">
                                        <i class="fas fa-eye me-2"></i>Xem kết quả
                                    </a>
                                {% endif %}
                            </div>
                            <div class="col-6">
                                <a class="btn btn-outline-primary btn-lg w-100 hover-underline-center" onclick="confirmRetakeExam()">
                                    <i class="fas fa-redo me-2"></i>Bắt đầu ôn thi lại
                                </a>
                            </div>
                        </div>
                    {% else %}
                        <a href="{{ url_for('doing_exam', exam_id=exam.id) }}"
                           class="btn fs-5 text-white text-decoration-none hover-underline-center mb-3" style="background: #384AD5;">
                            <i class="bi bi-play-circle"></i> Bắt đầu ôn thi
                        </a>
                    {% endif %}
                {% endif %}
            {% else %}
                <a href="{{ url_for('login', next=url_for('exam_detail', id=exam.id)) }}"
                   class="btn fs-5 text-white text-decoration-none hover-underline-center mb-3" style="background: #384AD5;">
                    <i class="bi bi-play-circle"></i> Bắt đầu ôn thi
                </a>
            {% endif %}
        </div>
    </div>

    <div class="notification-box notification-warning mt-2">
        <div class="notification-content-small">
            <i class="bi bi-info-circle-fill notification-icon-small"></i>
            <div class="notification-text small-text">
                Tài liệu ôn thi chỉ có giá trị tham khảo và ôn tập, không phải đề thi thực tế.
            </div>
        </div>
    </div>

    {% if current_user.is_authenticated %}
    <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #384AD5 0%, #5a67d8 100%);">
        <div class="card-body text-white">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-star me-2"></i>Đánh giá đề thi này
                    </h5>

                    {% if has_result %}
                        <div id="rating-container">
                            <p class="mb-2 opacity-75">Trải nghiệm của bạn như thế nào?</p>
                            <div class="star-rating mb-3" id="star-rating">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                            <div id="rating-message" class="rating-message" style="display: none;"></div>
                        </div>
                    {% else %}
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2 fs-5"></i>
                            <span>Hoàn thành bài thi để đánh giá</span>
                        </div>
                    {% endif %}
                </div>

                <div class="col-md-4 text-center">
                    <div class="rating-stats-card">
                        <div class="mb-2">
                            <div id="average-stars" class="star-display justify-content-center mb-1"></div>
                            <div class="fs-4 fw-bold">
                                <span id="average-rating-text">0.0</span><small class="fs-6 opacity-75">/5</small>
                            </div>
                            <div id="rating-summary" class="small opacity-75">(0 đánh giá)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- Hiển thị thống kê rating cho user chưa đăng nhập -->
    <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h5 class="card-title text-dark mb-2">
                        <i class="fas fa-star text-warning me-2"></i>Đánh giá từ cộng đồng
                    </h5>
                    <p class="text-muted mb-0">
                        <a href="{{ url_for('login', next=url_for('exam_detail', id=exam.id)) }}" class="text-decoration-none">Đăng nhập</a>
                        để đánh giá đề thi này
                    </p>
                </div>

                <div class="col-md-4 text-center">
                    <div class="rating-stats-card">
                        <div class="mb-2">
                            <div id="average-stars" class="star-display justify-content-center mb-1"></div>
                            <div class="fs-4 fw-bold text-dark">
                                <span id="average-rating-text">0.0</span><small class="fs-6 text-muted">/5</small>
                            </div>
                            <div id="rating-summary" class="small opacity-75">(0 đánh giá)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Tab content -->
<div class="container">
    <div class="card shadow-sm p-4 mb-5">
        <div class="card-body">
            <ul class="nav nav-tabs mb-3" id="examTabs">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#reviews" id="reviews-tab">
                        Bình luận ({{ comments_pagination.total }})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#ranking" id="ranking-tab">
                        Xếp hạng ({{ ranking_stats.total_participants if ranking_stats else 0 }})
                    </a>
                </li>
                {% if current_user.is_authenticated %}
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#results" id="results-tab">
                        Kết quả ôn tập ({{ user_results|length if user_results else 0 }})
                    </a>
                </li>
                {% endif %}
            </ul>

            <div class="tab-content">
                <!-- Tab bình luận -->
                <div class="tab-pane fade show active" id="reviews">
                    <div class="card-header d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-0">
                                <i class="fas fa-comments"></i> Bình luận & Đánh giá
                            </h5>
                            <small class="text-muted">
                                <span id="comments-count">{{ comments_pagination.total }}</span> bình luận,
                                <span id="ratings-count">{{ rating_stats.total_ratings }}</span> đánh giá
                                {% if rating_stats.total_ratings > 0 %}
                                    • Trung bình:
                                    <span class="text-warning">
                                        {% for i in range(1, 6) %}
                                            {% if i <= rating_stats.average_rating|round %}
                                                <i class="fas fa-star"></i>
                                            {% else %}
                                                <i class="far fa-star"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </span>
                                    <span class="fw-bold">{{ rating_stats.average_rating }}</span>/5
                                {% endif %}
                            </small>
                        </div>
                    </div>

                    {% if current_user.is_authenticated %}
                    <div class="card mb-4 border-primary">
                        <div class="card-body">
                            <h6 class="card-title">Viết bình luận</h6>
                            <form method="POST" action="{{ url_for('add_exam_comment') }}">
                                <input type="hidden" name="exam_id" value="{{ exam.id }}">
                                <div class="mb-3">
                                    <textarea class="form-control" name="content" rows="3" placeholder="Chia sẻ cảm nhận của bạn về đề thi này..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary hover-underline-center" style="background-color: #384AD5;">Gửi bình luận</button>
                            </form>
                        </div>
                    </div>
                    {% else %}
                    <div class="notification-box notification-info">
                        <div class="notification-content-small">
                            <i class="bi bi-info-circle notification-icon-small"></i>
                            <div class="notification-text">
                                <a href="{{ url_for('login', next=url_for('exam_detail', id=exam.id)) }}" class="login-link">Đăng nhập</a>
                                để viết đánh giá và xem kết quả ôn tập.
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Danh sách bình luận -->
                    {% if comments_pagination.items %}
                    {% for comment in comments_pagination.items %}
                        <div class="card mb-3 border border-light shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div class="d-flex align-items-center">
                                        <img src="{{ comment.user.avatar or url_for('static', filename='images/demo.png') }}"
                                             class="img-fluid rounded-circle me-3"
                                             style="width: 3rem; height: 3rem;" alt="avatar">
                                        <div>
                                            <div class="d-flex align-items-center gap-2">
                                                <strong>{{ comment.user.name }}</strong>
                                                <div class="user-rating" data-user-id="{{ comment.user.id }}"></div>
                                            </div>
                                            <small class="text-muted">{{ 'Quản trị viên' if comment.user.role.name == 'ADMIN' else 'Học sinh' }}</small>
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        {{ comment.created_at.strftime('%H:%M - %d/%m/%Y') }}
                                    </small>
                                </div>
                                <div class="text-body">
                                    <p class="mb-0">{{ comment.content }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Phân trang đánh giá -->
                    {% if comments_pagination.pages > 1 %}
                    <nav aria-label="Comments pagination" id="comments-pagination">
                        <ul class="pagination justify-content-center">
                            {% if comments_pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?id={{ exam.id }}&comment_page={{ comments_pagination.prev_num }}">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for page_num in comments_pagination.iter_pages() %}
                            {% if page_num %}
                            {% if page_num != comments_pagination.page %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?id={{ exam.id }}&comment_page={{ page_num }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">…</span>
                            </li>
                            {% endif %}
                            {% endfor %}

                            {% if comments_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link"
                                   href="?id={{ exam.id }}&comment_page={{ comments_pagination.next_num }}">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-chat-dots fs-1"></i>
                        <p class="mt-2">Chưa có đánh giá nào cho đề thi này.</p>
                        {% if current_user.is_authenticated %}
                        <p>Hãy là người đầu tiên đánh giá!</p>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Tab Bảng xếp hạng -->
                <div class="tab-pane fade" id="ranking">

                    <!-- Thông báo cho người tạo đề -->
                    {% if current_user.is_authenticated and current_user.id == exam.user_id %}
                    <div class="alert alert-info border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <i class="bi bi-person-check-fill text-primary fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading fw-bold text-primary mb-2 fs-5">
                                    <i class="bi bi-trophy me-1"></i>Thông báo cho người tạo đề
                                </h6>
                                <p class="mb-1 text-dark">
                                    Bạn là người tạo ra đề thi này, vì vậy <strong>kết quả của bạn sẽ không được hiển thị trong bảng xếp hạng</strong>
                                    để đảm bảo tính công bằng cho các thí sinh khác.
                                </p>
                                <small class="text-primary">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    Bạn vẫn có thể làm bài để kiểm tra đề thi và xem kết quả trong mục "Kết quả ôn tập".
                                </small>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Ô chú thích về quy tắc xếp hạng -->
                    <div class="alert alert-info border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-3">
                                <i class="bi bi-info-circle-fill text-primary fs-4"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="alert-heading fw-bold text-primary mb-2 fs-5">
                                    <i class="bi bi-trophy me-1"></i>Quy tắc xếp hạng
                                </h6>
                                <ul class="mb-1 text-dark">
                                    <li>Bảng xếp hạng chỉ tính <strong>lần làm bài đầu tiên</strong> của thí sinh</li>
                                    <li><strong>Người tạo đề thi không tham gia xếp hạng</strong> để đảm bảo tính công bằng</li>
                                    <li>Xếp hạng theo điểm số cao nhất, nếu bằng nhau thì ưu tiên người làm trước</li>
                                </ul>
                                <small class="text-primary">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    Điều này đảm bảo tính công bằng và chất lượng của bảng xếp hạng.
                                </small>
                            </div>
                        </div>
                    </div>

                    {% if ranking_stats and ranking_stats.total_participants > 0 %}
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card text-center bg-light">
                                <div class="card-body">
                                    <i class="bi bi-people-fill text-info fs-2"></i>
                                    <h5 class="card-title mt-2">{{ ranking_stats.total_participants }}</h5>
                                    <p class="card-text text-muted">Thí sinh tham gia</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center bg-light">
                                <div class="card-body">
                                    <i class="bi bi-graph-up text-success fs-2"></i>
                                    <h5 class="card-title mt-2">{{ ranking_stats.avg_score }}/100</h5>
                                    <p class="card-text text-muted">Điểm trung bình</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center bg-light">
                                <div class="card-body">
                                    <i class="bi bi-trophy-fill text-warning fs-2"></i>
                                    <h5 class="card-title mt-2">{{ ranking_stats.highest_score }}/100</h5>
                                    <p class="card-text text-muted">Điểm cao nhất</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 3 Podium -->
                    {% if ranking_pagination.items|length >= 3 %}
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="text-center mb-3">🏆 Top 3 Xuất Sắc</h5>
                            <div class="podium-container">
                                <div class="podium-item second-place">
                                    <img src="{{ ranking_pagination.items[1].avatar or url_for('static', filename='images/demo.png') }}"
                                         class="podium-avatar" alt="Avatar">
                                    <h6>{{ ranking_pagination.items[1].name }}</h6>
                                    <div class="podium-score">{{ ranking_pagination.items[1].score }}/100</div>
                                    <div class="podium-rank">
                                        <i class="bi bi-award-fill"></i>
                                        <span>2</span>
                                    </div>
                                </div>
                                <div class="podium-item first-place">
                                    <img src="{{ ranking_pagination.items[0].avatar or url_for('static', filename='images/demo.png') }}"
                                         class="podium-avatar" alt="Avatar">
                                    <h6>{{ ranking_pagination.items[0].name }}</h6>
                                    <div class="podium-score">{{ ranking_pagination.items[0].score }}/100</div>
                                    <div class="podium-rank">
                                        <i class="bi bi-trophy-fill"></i>
                                        <span>1</span>
                                    </div>
                                </div>
                                <div class="podium-item third-place">
                                    <img src="{{ ranking_pagination.items[2].avatar or url_for('static', filename='images/demo.png') }}"
                                         class="podium-avatar" alt="Avatar">
                                    <h6>{{ ranking_pagination.items[2].name }}</h6>
                                    <div class="podium-score">{{ ranking_pagination.items[2].score }}/100</div>
                                    <div class="podium-rank">
                                        <i class="bi bi-award-fill"></i>
                                        <span>3</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Bảng xếp hạng đầy đủ -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="80">Hạng</th>
                                    <th>Thí sinh</th>
                                    <th width="100">Điểm số</th>
                                    <th width="200">Ngày thi</th>
                                    <th width="150">Thời gian thi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for participant in ranking_pagination.items %}
                                <tr class="{% if current_user.is_authenticated and current_user.student and current_user.student.id == participant.student_id %}table-warning{% endif %}">
                                    <td>
                                        <div class="rank-badge">
                                            {% if participant.rank <= 5 %}
                                                {% if participant.rank == 1 %}
                                                    <i class="bi bi-trophy-fill text-warning"></i>
                                                {% elif participant.rank == 2 %}
                                                    <i class="bi bi-award-fill text-secondary"></i>
                                                {% elif participant.rank == 3 %}
                                                    <i class="bi bi-award-fill text-warning"></i>
                                                {% elif participant.rank == 4 %}
                                                    <i class="bi bi-star-fill text-primary"></i>
                                                {% elif participant.rank == 5 %}
                                                    <i class="bi bi-star-fill text-info"></i>
                                                {% endif %}
                                            {% endif %}
                                            <span class="ms-1">#{{ participant.rank }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img src="{{ participant.avatar or url_for('static', filename='images/demo.png') }}" class="rounded-circle me-2" style="width: 32px; height: 32px;" alt="Avatar">
                                            <div>
                                                <span class="fw-bold">{{ participant.name }}</span>
                                                {% if current_user.is_authenticated and current_user.student and current_user.student.id == participant.student_id %}
                                                    <small class="text-primary d-block">Bạn</small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge {% if participant.score >= 80 %}bg-success{% elif participant.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ participant.score }}/100
                                        </span>
                                    </td>
                                    <td>
                                        <small>{{ participant.taken_exam.strftime('%d/%m/%Y lúc %H:%M:%S') }}</small>
                                    </td>
                                    <td>
                                        <span>
                                            {% if participant.time_taken %}
                                                {% set minutes = (participant.time_taken // 60) %}
                                                {% set seconds = (participant.time_taken % 60) %}
                                                {% if minutes > 0 %}
                                                    {{ minutes }} phút {% if seconds > 0 %}{{ seconds }} giây{% endif %}
                                                {% else %}
                                                    {{ seconds }} giây
                                                {% endif %}
                                            {% else %}
                                                --
                                            {% endif %}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Phân trang xếp hạng -->
                    {% if ranking_pagination.pages > 1 %}
                    <nav aria-label="Ranking pagination" class="mt-3">
                        <ul class="pagination justify-content-center">
                            {% if ranking_pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="?id={{ exam.id }}&ranking_page={{ ranking_pagination.prev_num }}#ranking" onclick="switchToRankingTab()">
                                    <i class="bi bi-chevron-left"></i>
                                </a>
                            </li>
                            {% endif %}

                            {% for page_num in ranking_pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != ranking_pagination.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="?id={{ exam.id }}&ranking_page={{ page_num }}#ranking" onclick="switchToRankingTab()">
                                            {{ page_num }}
                                        </a>
                                    </li>
                                    {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                    {% endif %}
                                {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">…</span>
                                </li>
                                {% endif %}
                            {% endfor %}

                            {% if ranking_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?id={{ exam.id }}&ranking_page={{ ranking_pagination.next_num }}#ranking" onclick="switchToRankingTab()">
                                    <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-trophy fs-1 text-muted"></i>
                        <p class="mt-2 text-muted">
                            {% if current_user.is_authenticated and current_user.id == exam.createBy_id %}
                                Chưa có thí sinh nào làm bài thi này. Hãy chia sẻ đề thi để mọi người cùng tham gia!
                            {% else %}
                                Chưa có thí sinh nào làm bài thi này.
                            {% endif %}
                        </p>
                        {% if current_user.is_authenticated and current_user.id != exam.user_id %}
                        <a href="{{ url_for('doing_exam', exam_id=exam.id) }}" class="btn text-white text-decoration-none hover-underline-center" style="background: #384AD5;">
                            <i class="bi bi-play-circle"></i> Hãy là người đầu tiên!
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>

                <!-- Tab Kết quả ôn tập -->
                {% if current_user.is_authenticated %}
                <div class="tab-pane fade" id="results">
                    {% if user_results %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                            <tr>
                                <th>Lần thi</th>
                                <th>Điểm số</th>
                                <th>Thời gian đã làm bài</th>
                                <th>Ngày thi</th>
                                <th>Trạng thái</th>
                                <th>Hành động</th>
                            </tr>
                            </thead>
                            <tbody>
                            {% for result in user_results %}
                            <tr>
                                <td>{{ loop.revindex }}</td>
                                <td>
                                    <span class="badge {% if result.score >= 80 %}bg-success{% elif result.score >= 50 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {{ result.score }}/100
                                    </span>
                                </td>
                                <td>
                                    {% if result.time_taken %}
                                        {% set minutes = (result.time_taken // 60) %}
                                        {% set seconds = (result.time_taken % 60) %}
                                        {% if minutes > 0 %}
                                            {{ minutes }} phút {% if seconds > 0 %}{{ seconds }} giây{% endif %}
                                        {% else %}
                                            {{ seconds }} giây
                                        {% endif %}
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                                <td>{{ result.taken_exam.strftime('%H:%M:%S %d/%m/%Y') }}</td>
                                <td>
                                    {% if result.score >= 50 %}
                                    <span class="text-success">Đạt</span>
                                    {% else %}
                                    <span class="text-danger">Không đạt</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('view_exam_result', result_id=result.id) }}"
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="bi bi-eye"></i> Xem chi tiết
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Thống kê cá nhân -->
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">{{ user_results|length }}</h5>
                                    <p class="card-text">Số lần thi</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-success">
                                        {% if user_results|length > 0 %}
                                        {{ "%.1f"|format((user_results|sum(attribute='score'))/user_results|length)
                                        }}/100
                                        {% else %}
                                        0/100
                                        {% endif %}
                                    </h5>
                                    <p class="card-text">Điểm trung bình</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title text-warning">
                                        {{ user_results|selectattr('score', '>=', 5)|list|length }}
                                    </h5>
                                    <p class="card-text">Số lần đạt</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-graph-up fs-1"></i>
                        <p class="mt-2">Bạn chưa thi đề này.</p>
                        <a href="{{ url_for('doing_exam', exam_id=exam.id) }}" class="btn text-white text-decoration-none hover-underline-center" style="background: #384AD5;">
                            <i class="bi bi-play-circle"></i> Bắt đầu thi ngay
                        </a>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận làm lại lúc còn đang làm -->
<div class="modal fade" id="restartExamModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0"
                 style="background: linear-gradient(135deg, #ff416c 0%, #ff4757 100%);">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-redo me-2"></i>Xác nhận làm lại từ đầu
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-exclamation-triangle text-danger fs-1 mb-3"></i>
                    <h5 class="fw-bold">Bạn có chắc chắn muốn làm lại bài thi không?</h5>
                    <p class="text-muted">Toàn bộ tiến trình hiện tại sẽ bị xóa và không thể khôi phục.</p>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <div class="text-center p-3 bg-success bg-opacity-10 rounded-3">
                            <i class="fas fa-check-circle text-white fs-3 mb-2"></i>
                            <h3 class="mb-0 text-white fw-bold" id="restart-answered-count">0</h3>
                            <small class="text-white">Câu đã làm</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center p-3 bg-warning bg-opacity-10 rounded-3">
                            <i class="fas fa-trash-alt text-danger fs-3 mb-2"></i>
                            <h3 class="mb-0 text-danger fw-bold">SẼ MẤT</h3>
                            <small class="text-danger">Tiến trình</small>
                        </div>
                    </div>
                </div>

                <!-- Thêm thông tin thời gian đã dùng (nếu có) -->
                <div class="alert alert-warning mt-2">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-clock me-2"></i>
                        <div>
                            <strong>Thời gian đã làm bài:</strong>
                            <span id="restart-time-used">0 phút</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-danger rounded-pill px-4" data-exam-id="{{ exam.id }}" data-answered-count="{{ session.user_answers|length if session.user_answers else 0 }}" onclick="restartExam()">
                    <i class="fas fa-redo me-2"></i>Làm lại từ đầu
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận làm lại bài thi sau khi làm 1 lần -->
<div class="modal fade" id="retakeExamModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0"
                 style="background: linear-gradient(135deg, #384AD5 0%, #5a67d8 100%);">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-redo me-2"></i>Bắt đầu ôn thi lại
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-4">
                    <i class="fas fa-question-circle text-primary fs-1 mb-3"></i>
                    <h5 class="fw-bold">Bạn có muốn làm lại bài thi này không?</h5>
                    <p class="text-muted">Bạn sẽ tạo một phiên thi mới và có thể cải thiện điểm số của mình.</p>
                </div>

                <div class="notification-box notification-info">
                    <div class="notification-content-small">
                        <i class="bi bi-info-circle notification-icon-small"></i>
                        <div class="notification-text small-text">
                            Điểm số cao nhất của bạn sẽ được lưu lại để so sánh.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Hủy
                </button>
                <button type="button" class="btn btn-primary rounded-pill px-4" onclick="retakeExam()" style="background: #384AD5;">
                    <i class="fas fa-play me-2"></i>Bắt đầu làm bài
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal QR Code -->
<div class="modal fade" id="qrCodeModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-gradient text-white border-0"
                 style="background: linear-gradient(135deg, #384AD5 0%, #5a67d8 100%);">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-qr-code me-2"></i>Mã QR Đề Thi
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
                <div id="qr-loading" class="mb-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tạo mã QR...</span>
                    </div>
                    <p class="mt-2">Đang tạo mã QR...</p>
                </div>

                <div id="qr-content" style="display: none;">
                    <div class="mb-3">
                        <img id="qr-image" src="" alt="QR Code" class="img-fluid" style="max-width: 250px;">
                    </div>
                    <h6 id="qr-exam-name" class="fw-bold mb-2 fs-3"></h6>
                    <p class="text-muted mb-3">Quét mã QR để truy cập đề thi</p>

                    <div class="input-group mb-3">
                        <input type="text" id="qr-url" class="form-control" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="copyQRUrl()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>

                <div id="qr-error" style="display: none;" class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="qr-error-message">Có lỗi xảy ra khi tạo mã QR</span>
                </div>
            </div>
            <div class="modal-footer border-0 p-4">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">
                    <i class="bi bi-x me-2"></i>Đóng
                </button>
                <button type="button" id="download-qr" class="btn btn-primary rounded-pill px-4" style="background: #384AD5; display: none;">
                    <i class="bi bi-download me-2"></i>Tải xuống
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/rating.js') }}"></script>
<script>
    const userAnswers = {{ (existing_session.user_answers | tojson) if existing_session and existing_session.user_answers else '{}' }};
    window.sessionData = {
        user_answers: userAnswers
    };

    function confirmRestartExam() {
        updateRestartModalStats();

        const modal = new bootstrap.Modal(document.getElementById('restartExamModal'));
        modal.show();
    }

    function updateRestartModalStats() {
        const answeredCount = (typeof userAnswers !== 'undefined' && userAnswers)
            ? Object.keys(userAnswers).length
            : (window.sessionData && window.sessionData.user_answers)
                ? Object.keys(window.sessionData.user_answers).length
                : 0;

        document.getElementById('restart-answered-count').textContent = answeredCount;

        const examDuration = {{ exam.duration }};

        {% if session and session.start_time %}
            const startTime = new Date('{{ session.start_time.isoformat() }}');
            {% if session.is_paused and session.pause_time%}
                const endTime = new Date('{{ session.pause_time.isoformat() }}');
                const totalElapsedSeconds = Math.floor((endTime - startTime) / 1000);

                const pausedDuration = {{ session.total_paused_duration or 0 }};
                const actualUsedTime = Math.max(0, totalElapsedSeconds - pausedDuration);

                const usedMinutes = Math.floor(actualUsedTime / 60);
                const usedSeconds = actualUsedTime % 60;
            {% else %}
                const actualUsedTime = 0;
            {% endif %}
            let timeText = '';
            if (usedMinutes > 0) {
                timeText = `${usedMinutes} phút`;
                if (usedSeconds > 0) {
                    timeText += ` ${usedSeconds} giây`;
                }
            } else {
                timeText = `${Math.max(0, usedSeconds)} giây`;
            }
            
            document.getElementById('restart-time-used').textContent = timeText;

            const timeAlert = document.querySelector('#restartExamModal .alert-warning');
            if (timeAlert) {
                timeAlert.style.display = 'block';
            }
        {% else %}
            const timeAlert = document.querySelector('#restartExamModal .alert-warning');
            if (timeAlert) {
                timeAlert.style.display = 'none';
            }
        {% endif %}
    }

    function restartExam() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('restartExamModal'));
        modal.hide();

        const examId = getExamId();

        if (!examId) {
            alert('Không thể xác định bài thi!');
            return;
        }

        showLoadingOverlay('Đang reset bài thi...', 'Vui lòng đợi trong giây lát');

        fetch(`/api/exam/${examId}/restart`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/doing-exam/${examId}?restart=1`;
            } else {
                showErrorOverlay('Lỗi: ' + (data.error || 'Không thể reset bài thi'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showErrorOverlay('Không thể kết nối tới máy chủ');
        });
    }

    function getExamId() {
        if (typeof examId !== 'undefined') return examId;

        const urlParams = new URLSearchParams(window.location.search);
        const urlExamId = urlParams.get('id') || urlParams.get('exam_id');
        if (urlExamId) return urlExamId;

        const pathMatch = window.location.pathname.match(/doing-exam\/(\d+)/);
        if (pathMatch) return pathMatch[1];

        const examElement = document.querySelector('[data-exam-id]');
        if (examElement) return examElement.dataset.examId;

        return null;
    }

    function showLoadingOverlay(title, message) {
        const container = document.querySelector('.container-fluid') || document.body;
        container.innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">${title}</span>
                </div>
                <h4>${title}</h4>
                <p class="text-muted">${message}</p>
            </div>
        `;
    }

    function showErrorOverlay(errorMessage) {
        const container = document.querySelector('.container-fluid') || document.body;
        container.innerHTML = `
            <div class="alert alert-danger text-center py-5">
                <i class="fas fa-exclamation-triangle fs-1 mb-3"></i>
                <h4>${errorMessage}</h4>
                <button class="btn btn-primary mt-3" onclick="window.location.reload()">
                    <i class="fas fa-redo me-2"></i>Thử lại
                </button>
            </div>
        `;
    }

    function confirmRetakeExam() {
        const modal = new bootstrap.Modal(document.getElementById('retakeExamModal'));
        modal.show();
    }

    function retakeExam() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('retakeExamModal'));
        modal.hide();

        const examId = getExamId();

        if (!examId) {
            alert('Không thể xác định bài thi!');
            return;
        }

        showLoadingOverlay('Đang khởi tạo bài thi mới...', 'Vui lòng đợi trong giây lát');

        window.location.href = `/doing-exam/${examId}`;
    }

    function switchToRankingTab() {
        document.getElementById('ranking-tab').click();
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (window.location.hash === '#ranking') {
            document.getElementById('ranking-tab').click();
        }
    });

    function showQRCode() {
        const examId = getExamId();
        if (!examId) {
            alert('Không thể xác định bài thi!');
            return;
        }

        const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
        modal.show();

        document.getElementById('qr-loading').style.display = 'block';
        document.getElementById('qr-content').style.display = 'none';
        document.getElementById('qr-error').style.display = 'none';
        document.getElementById('download-qr').style.display = 'none';

        fetch(`/api/exam/${examId}/qr-code`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('qr-loading').style.display = 'none';

                if (data.success) {
                    document.getElementById('qr-image').src = data.qr_image;
                    document.getElementById('qr-exam-name').textContent = data.exam_name;
                    document.getElementById('qr-url').value = data.exam_url;
                    document.getElementById('qr-content').style.display = 'block';
                    document.getElementById('download-qr').style.display = 'inline-block';

                    window.qrData = data.qr_image;
                } else {
                    document.getElementById('qr-error-message').textContent = data.error || 'Có lỗi xảy ra khi tạo mã QR';
                    document.getElementById('qr-error').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('qr-loading').style.display = 'none';
                document.getElementById('qr-error-message').textContent = 'Không thể kết nối tới máy chủ';
                document.getElementById('qr-error').style.display = 'block';
            });
    }

    function copyQRUrl() {
        const urlInput = document.getElementById('qr-url');
        urlInput.select();
        urlInput.setSelectionRange(0, 99999);

        try {
            document.execCommand('copy');
            const originalText = urlInput.nextElementSibling.innerHTML;
            urlInput.nextElementSibling.innerHTML = '<i class="bi bi-check text-success"></i>';
            setTimeout(() => {
                urlInput.nextElementSibling.innerHTML = originalText;
            }, 1000);
        } catch (err) {
            console.error('Không thể sao chép: ', err);
        }
    }

    document.getElementById('download-qr').addEventListener('click', function() {
        if (window.qrData) {
            const link = document.createElement('a');
            link.download = 'exam-qr-code.png';
            link.href = window.qrData;
            link.click();
        }
    });
</script>

{% endblock %}